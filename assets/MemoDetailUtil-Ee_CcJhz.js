import{j as t}from"./index-6nPoEYnd.js";import{i as X,Q as K,cX as I,a4 as D,p as T,a2 as ee,d1 as te,d2 as ae,d3 as S,d4 as se,ab as P,t as le,j as ne,co as oe,s as ie,e as U,c_ as re,cr as ce}from"./App-gfyO5pOu.js";import{r as h,a as de,c as me,u as ue}from"./router-BlMcuVHC.js";import{u as ge}from"./useWindowDimensions-c3RsCB5T.js";import{T as he}from"./TwTextArea-__CGitm_.js";import{T as xe}from"./TwDatePicker-Cx7EWP-V.js";import{T as fe}from"./TwSelect-DDCOTpp7.js";import{T as pe,D as ve,H as we}from"./HtmlBadge-Dah4O0_6.js";import{u as ye,a as je}from"./MemoComm-BRlQW12c.js";import"./vendor-CCYiWZgt.js";import"./IpInfo-B-3rtzFg.js";const be=l=>{const[m,d]=h.useState(l.imageList),[o,r]=h.useState(l.content),{t:s}=X(),[n,y]=h.useState(),x=h.useRef(),F=h.useRef(!1),c=h.useRef(null),f=h.useRef([]),{height:k}=ge(),g={edTitle:l.title,edGbn:l.gbn?l.gbn:"etc",edDate:l.date,content:l.content,memoTxt:l.content,htmlCheck:"N",iconCheck:"N"},{register:C,handleSubmit:$,trigger:ke,control:j,setValue:p,getValues:b,watch:Ce,formState:{errors:Ne,isSubmitting:De}}=K({mode:"onChange",defaultValues:g});h.useEffect(()=>{C("edDate"),C("memoTxt")},[]),h.useEffect(()=>{f.current=[],x.current=l.content},[l.content]),I("DragDropFile.imgList",imgList);const L=async e=>{await l.onPostSubmit(e,m,f.current)},R=()=>{$(L)()},B=e=>{d(e)},A=e=>{let a=x.current;e.ext==="jpg"||e.ext==="png"?(a+=`<img src='${e.url}'/>`,v(`<img src='${e.url}'/>
`)):e.ext==="mp4"?(a+=`<video preload="auto" controls="" src='${e.url}'></video>`,v(`<video preload="auto" controls="" src='${e.url}'></video>`)):(a+=`<a src='${e.url}'>${e.name}}</a>`,v(`${s("download_link_text")}
<a href="${e.url}" target="_blank">${e.name}</a>
`)),x.current=a},Y=e=>l.onRename(e,b("edTitle")),M=e=>{x.current=e},H=e=>{f.current=e};function q(e){v(`<img src='${e}'/>`)}function O(){let e="";m&&m.length>0&&m.map((a,i)=>{e+=`<img src="/data/memo/${a.key}.${a.ext}" style="width: 50px;"/>
`}),e!==""&&v(e)}const V=[{value:"none",label:s("none")},{value:"react",label:s("react")},{value:"css",label:s("css")},{value:"android",label:s("android")},{value:"java",label:s("java")},{value:"image",label:s("image")},{value:"etc",label:s("etc")},{value:"mui",label:s("mui")}],v=e=>{const a=c.current;if(a){const i=a.selectionStart,u=a.selectionEnd,w=o.slice(0,i),N=o.slice(u);r(w+e+N),p("memoTxt",w+e+N),setTimeout(()=>{a.selectionStart=a.selectionEnd=i+e.length,a.focus()},100)}},G=e=>{v(e)},z=e=>e?/\.(jpg|jpeg|png|gif|bmp|webp|svg)/i.test(e)||e.includes("image")||e.includes("img"):!1,J=async()=>{await te("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1")},Z=async()=>{const e=await ae("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1");let a="";e.map(i=>{a+=i+`
`}),v(a)},Q=async()=>{const e=b("edFilePath");if(e===""){const a=[];let i=c.current.value;i=i.replace(/<img src="\/data\/memo\//g,""),i=i.replace(/ style="width: 50px;"/g,""),i=i.replace(/"\/>/g,""),i=i.replace(/ /g,""),i.split(`
`).forEach(async u=>{u.indexOf(".")>0&&a.push(u)}),a.length>0&&await l.onFilePathList(a)}else await l.onFilePath(e)},W=e=>new Promise((a,i)=>{const u=new Image;u.crossOrigin="anonymous",u.onload=()=>{const w=document.createElement("canvas"),N=w.getContext("2d");w.width=u.width,w.height=u.height,N.drawImage(u,0,0);try{const _=w.toDataURL("image/png");a(_)}catch(_){i(_)}},u.onerror=()=>{i(new Error("Failed to load image"))},u.src=e});return t.jsx("div",{className:"my-2 mb-[50px], w-full",children:t.jsxs("form",{onSubmit:$(L),style:{width:"100%",minHeight:"300px",maxHeight:{height:k},display:"flex",flexDirection:"column"},children:[t.jsx(pe,{onSubmit:e=>R(),onCancel:l.onCancel,isSubmitting:F.current}),t.jsx(ve,{control:j,onDelete:B,onInsert:A,onRename:Y,setContent:M,onFileUpload:H,imageList:l.imageList}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{className:"w-full",children:t.jsx(D,{name:"edTitle",placeholder:s("title_placeholder"),control:j,className:"w-full",rules:{required:s("required_field"),minLength:{value:2,message:s("min_length_2")}},onChange:e=>{e.preventDefault(),p("edTitle",e.target.value)}})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(fe,{name:"edGbn",label:s("category"),control:j,rules:{required:!0},placeholder:s("category_placeholder"),options:V,className:"",allClassName:"max-w-40",onChange:e=>{e.preventDefault();const a=e.target.value;p("edGbn",a)}}),t.jsx(xe,{id:"edDate",name:"edDate",placeholder:s("select_date_placeholder"),control:j,onChange:(e,a)=>{p("edDate",a)}})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(D,{name:"edUrl",placeholder:s("base64_url_placeholder"),control:j,className:"w-full",allClassName:"w-full",onChange:e=>{e.preventDefault();const a=e.target.value;p("edUrl",a),y(a)}}),t.jsx(T,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),q(b("edUrl2"))},children:s("apply")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(D,{name:"edUrl2",placeholder:s("base64_image_data_placeholder"),className:"w-full",allClassName:"w-full",variant:"filled",size:"md",value:b("edUrl2")||""}),t.jsx(T,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),O()},children:s("add_attachment")})]}),t.jsxs("div",{className:"flex gap-2 w-full",children:[t.jsx(D,{name:"edFilePath",placeholder:s("add_to_imagelist_placeholder"),className:"w-full",allClassName:"w-full",control:j,onChange:e=>{e.preventDefault();const a=e.target.value;p("edFilePath",a)}}),t.jsx(T,{size:"sm",variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),Q()},children:s("file_path")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(T,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),J()},children:s("all_files")}),t.jsx(T,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),Z()},children:s("all_files_10")})]})]}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{children:t.jsx("div",{className:"max-h-100 overflow-y-scroll",children:t.jsx(ee,{postData:o})})}),t.jsx("div",{children:t.jsx(he,{ref:c,className:"",value:o,onChange:e=>{p("memoTxt",e),r(e)},rows:20})}),b("edUrl")&&z(b("edUrl"))&&t.jsx("div",{className:"mt-2 p-2 border border-gray-300 dark:border-gray-600 rounded",children:t.jsx("img",{src:n,alt:s("preview"),className:"max-w-full h-auto max-h-48 object-contain",onLoad:async e=>{try{const a=await W(n);p("edUrl2",a)}catch(a){console.error("Base64 conversion failed:",a)}},onError:e=>{e.target.style.display="none"}})})]}),t.jsx(we,{onClick:G}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"})]})})},Te=async(l,m,d,o,r)=>{const s=l==="memo"?`${l}/${m.uid}/`:`${l}/`,n=await se(s,o.key,r,o.ext);if(n.success){const y=l==="memo"?`memo_txt/${m.uid}/${d}/image/`:`home_txt/${d}/image/`;P(y+o.key,null);const x={...o,key:n.key,url:n.url,name:`${n.key}.${o.ext}`};return P(y+n.key,x),x}},E=async(l,m,d)=>{if(Array.isArray(d)&&d.length>0)for(const o of d)try{await S(l,m,o)}catch(r){console.error(`Error getting path for ${o}:`,r)}else typeof d=="string"&&await S(l,m,d)},Ae=({rootDb:l})=>{const{scrollYProgress:m}=ye();je(m,{stiffness:100,damping:30,restDelta:.001});const d=de(),{user:o}=le(),{memoId:r}=me();ue();const s=ne(),{memoMap:n,isLoading:y}=oe(l,o,r);I("MemoDetailEdit.title=",n?.title);const x=()=>{const c=`/${l==="memo"?"m":l}/${r==="insert"?"":r}`;d(c)},F=(c,f,k)=>{s(re({rootDb:l,memoId:r,values:c,imageList:f,files:k,user:o})).unwrap().then(g=>{s({type:"tabs/updateTabTitle",payload:{id:g.key,title:g.title}}),s({type:"bookmark/updateBookmarkTitle",payload:{id:g.key,title:g.title}}),s(ce({id:g.key,newTitle:g.title}));const C=`/${g.rootDb==="memo"?"m":g.rootDb}/${g.key}`;d(C,{state:{reflash:!0}})})};return h.useEffect(()=>{n&&n.title!==void 0&&ie({title:n.title,description:n.title});function c(){document.querySelectorAll("pre").forEach((f,k)=>{})}n&&n.memo!==null&&c()},[n]),r===""||o===void 0?t.jsx(t.Fragment,{}):n===void 0||y?t.jsx(U,{}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"w-full p-0 m-0",children:n&&(n.title===void 0||n.title===""||n.title===null)?t.jsx(U,{}):t.jsx(be,{onPostSubmit:F,onCancel:x,onRename:(c,f)=>Te(l,o,r,c,f),onFilePath:c=>E(o.uid,r,c),onFilePathList:c=>E(o.uid,r,c),title:n?.title,gbn:n?.gbn,date:n?.date,htmlCheck:n?.html?n?.html==="Y"?"Y":"N":"Y",iconCheck:!n?.icon==="Y"?"Y":"N",content:n?.memo,imageList:n?.image})})})};export{Ae as MemoDetailUtil,Ae as default};

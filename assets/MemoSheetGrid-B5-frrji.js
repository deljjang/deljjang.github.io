import{j as t}from"./index-6nPoEYnd.js";import{i as te,A as se,b as F,m as B,p as q,t as Ie,j as Me,k as Z,cR as Ne,cS as Te,cT as Ae,V as U,cU as Re,bm as Ee,cV as ee,bw as Be,f as Oe,cW as Pe,ab as v,c5 as W,cX as H,cY as Le}from"./App-gfyO5pOu.js";import{T as ze}from"./MemoComm-BRlQW12c.js";import{c as Ve,r as h}from"./router-BlMcuVHC.js";import"./vendor-CCYiWZgt.js";import"./IpInfo-B-3rtzFg.js";const Ye=({onInsert:N,onDelete:i,onReload:x,onCsvSave:c,onSaveAll:j,onCopy:D,colorPalette:O,textColorPalette:C,handleColorClick:T,handleColorRightClick:u,handleTextColorClick:A,handleTextColorRightClick:w})=>{const{t:k}=te(),I=[D&&{id:"copy",label:k("public"),onClick:D,color:"secondary"},{id:"csv",label:k("csv_save"),onClick:c,color:"sky"},{id:"save",label:k("save"),onClick:j,color:"sky"},{id:"delete",label:k("delete"),onClick:i,color:"warning"},{id:"insert",label:k("insert"),onClick:N,color:"sky"}].filter(Boolean),_={hidden:{opacity:0,y:10},visible:l=>({opacity:1,y:0,transition:{delay:l*.05,type:"spring",stiffness:300,damping:20}}),exit:l=>({opacity:0,y:10,transition:{delay:(I.length-l)*.05,duration:.1}})};return t.jsx(se,{children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx("div",{className:"flex flex-col items-end space-y-2 p-1 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:[I.slice(0,3),I.slice(3)].map((l,p)=>l.length>0&&t.jsx("div",{className:`${p===0?"flex items-center justify-end space-x-2":`w-full ${F.between}`}`,children:l.map((b,P)=>{const L=p*3+P;return t.jsx(B.div,{custom:L,variants:_,initial:"hidden",animate:"visible",exit:"exit",children:t.jsx(q,{size:"sm",color:b.color,onClick:b.onClick,children:b.label})},b.id)})},`group-${p}`))}),t.jsx("div",{children:t.jsx(B.div,{custom:1,variants:_,initial:"hidden",animate:"visible",exit:"exit",className:"p-2 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"flex items-center justify-end space-x-1",children:O.map(l=>t.jsx("div",{onClick:()=>T(l),onContextMenu:p=>u(p,l),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white",style:{backgroundColor:l}},`bg-${l}`))}),t.jsx("div",{className:"flex items-center justify-end space-x-1",children:C.map((l,p)=>t.jsx("div",{onClick:()=>A(l),onContextMenu:b=>w(b,l),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white flex items-center justify-center text-sm font-bold",style:{backgroundColor:"#fff",color:l},children:p%2===0?"A":"a"},`text-${l}`))})]})},"color-palettes")})]})})},Ke=({detailData:N})=>{const{user:i}=Ie(),{t:x}=te(),{sheetId:c}=Ve(),j=Me(),D=Z(e=>e.sheet.sheetData),O=Z(e=>e.sheet.isLoading),[C,T]=h.useState([]),u=h.useRef(null),A=h.useRef(null),w=h.useRef(null),[k,I]=h.useState([]),[_,l]=h.useState(void 0),[p,b]=h.useState(void 0),[P,L]=h.useState(""),[oe,z]=h.useState({isOpen:!1}),[ne,S]=h.useState({show:!1,message:""}),[V,G]=h.useState(""),[Y,ae]=h.useState(!1),[re,J]=h.useState(!1),[R,K]=h.useState(""),ce=["#FFADAD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF"],ie=["#000000","#D00000","#AE4600","#006400","#00529B","#0018A8","#5A00A8","#A800A8"],le=e=>{if(!u.current?.hotInstance||!w.current)return;const{row:s,col:a,row2:n,col2:d}=w.current,r=Math.min(s,n),m=Math.max(s,n),$=Math.min(a,d),E=Math.max(a,d),f=[..._];let M=!1;for(let g=r;g<=m;g++){f[g]||(f[g]=Array(C.length).fill(""));for(let y=$;y<=E;y++)f[g][y]!==e&&(f[g][y]=e,M=!0)}M&&l(f)},de=(e,o)=>{e.preventDefault();const s=u.current?.hotInstance;if(!s)return;const a=s.countRows(),n=[..._];let d=!1;for(let r=0;r<a;r++)if(n[r])for(let m=0;m<n[r].length;m++)n[r][m]===o&&(n[r][m]=void 0,d=!0);d&&l(n)},he=e=>{if(!u.current?.hotInstance||!w.current)return;const{row:s,col:a,row2:n,col2:d}=w.current,r=Math.min(s,n),m=Math.max(s,n),$=Math.min(a,d),E=Math.max(a,d),f=[...p];let M=!1;for(let g=r;g<=m;g++){f[g]||(f[g]=Array(C.length).fill(void 0));for(let y=$;y<=E;y++)f[g][y]!==e&&(f[g][y]=e,M=!0)}M&&b(f)},ue=(e,o)=>{e.preventDefault();const s=u.current?.hotInstance;if(!s)return;const a=s.countRows(),n=[...p];let d=!1;for(let r=0;r<a;r++)if(n[r])for(let m=0;m<n[r].length;m++)n[r][m]===o&&(n[r][m]=void 0,d=!0);d&&b(n)};h.useEffect(()=>{c&&i&&C.length>0&&j(Ne({sheetId:c,userId:i.uid}))},[c,i,C.length,j]),h.useEffect(()=>{D&&(I(D.rowData),l(D.colorData),b(D.colorTextData))},[D]);function me(){const e=N?.scrollY?N.scrollY:0;window.scrollTo({top:e})}h.useEffect(()=>{c&&i&&(j(Te({sheetId:c,userId:i.uid})).then(e=>{T(e.payload)}),j(Ae({sheetId:c,userId:i.uid})).then(e=>{G(e.payload)}),me())},[c,i,j]);const fe=async()=>{u.current.hotInstance.getPlugin("exportFile").downloadFile("csv",{filename:`sheet_${c}`,mimeType:"text/csv",bom:!1,columnDelimiter:",",rowDelimiter:`\r
`})};async function xe(){const e=u.current?.hotInstance;if(!e)return;let o;if(w.current&&w.current.row>=0){const s=w.current.row;o=s+1,e.alter("insert_row_below",s,1)}else o=0,e.alter("insert_row_above",0,1);e.selectCell(o,0)}const we=async({rowsDB:e,bgColorDataToSave:o,textColorDataToSave:s})=>{try{await ve(e,o,s),await j(Le({userId:i.uid,sheetId:c,rowsDB:e,bgColorDataToSave:o,textColorDataToSave:s})),S({show:!0,message:x("save_completed")}),setTimeout(()=>S({show:!1,message:""}),2e3)}catch(a){console.error("Save failed:",a)}},pe=async()=>{v(`memo_sheet_data/${i?.uid}/${c}/memo`,R),G(R),J(!1)},ge=()=>{K(V),J(!0)},ve=(e,o,s)=>{v(`memo_sheet_data/${i?.uid}/${c}/data`,null),e.map((a,n)=>{v(`memo_sheet_data/${i?.uid}/${c}/data/${n}`,a)}),v(`memo_sheet_data/${i?.uid}/${c}/color`,o),v(`memo_sheet_data/${i?.uid}/${c}/textColor`,s),v(`memo_sheet/${i?.uid}/${c}/createdAt`,Date.now()),v(`memo_sheet/${i?.uid}/${c}/count`,e.length)},be=async()=>{try{if(!i||!c)throw new Error("User or Sheet ID is missing.");const e=`memo_sheet/${i.uid}/${c}`,o=`memo_sheet_data/${i.uid}/${c}`,[s,a]=await Promise.all([W(e),W(o)]);if(H("sheetMeta=",s),H("sheetData=",a),!s)throw new Error("Sheet metadata not found.");const n=await W(`home_txt/${c}`);H("data=",n);const d={title:n?.title||s.title,color:a?.color||[],columns:s.columns||[],createdAt:s.createdAt||Date.now(),data:a?.data||[],gbn:n?.gbn||"etc",html:"sheet",memo:n?.memo||a?.memo||"",textColor:a?.textColor||[]};await v(`${e}/public`,"Y"),await v(`home_txt/${c}`,d),await v(`home_txt/${c}`,d),ye(x("copy_completed"))}catch(e){console.error("Copy failed:",e);const o=`${x("copy_failed")} ${e.message?`: ${e.message}`:""}`;S({show:!0,message:o}),setTimeout(()=>S({show:!1,message:""}),3e3)}},Ce=()=>{be()},ye=e=>{S({show:!0,message:e}),setTimeout(()=>S({show:!1,message:""}),2e3)},X=async(e=!0)=>{const o=u.current?.hotInstance;if(!o)return;const s=o.getSourceData(),a=[];s.forEach((r,m)=>{r.id=m;const $=[];C.forEach((E,f)=>{$.push(r[f]?r[f]:"")}),a.push(JSON.stringify($))});const n=_.map(r=>JSON.stringify(r||[])),d=p.map(r=>JSON.stringify(r||[]));we({rowsDB:a,bgColorDataToSave:n,textColorDataToSave:d})},je=(e,o,s,a)=>{w.current={row:e,col:o,row2:s,col2:a}},De=async(e,o,s)=>{X(!1);const a=u.current?.hotInstance;if(!a)return;const n=C.map((d,r)=>({...d,width:a.getColWidth(r)}));T(n),v(`memo_sheet/${i?.uid}/${c}/columns`,n)},ke=e=>{u.current?.hotInstance.alter("remove_row",e,1),w.current=null},_e=()=>{z({isOpen:!1})},Se=()=>{u.current.hotInstance;const e=w.current.row;z({isOpen:!1}),ke(e)},$e=async()=>{if(w.current&&u.current?.hotInstance){const e=x("delete_confirm_title"),o=x("delete_confirm_message_simple");z({isOpen:!0,title:e,message:o,color:"warning"})}else S({show:!0,message:x("select_row_to_delete")}),setTimeout(()=>{S({show:!1,message:""})},2e3)};if(i===void 0)return t.jsx("div",{className:"flex flex-col items-center justify-center h-full w-full mt-50",children:t.jsx(U,{children:x("login_required")})});const Q=()=>{const e=A.current.value;L(e);const o=u.current?.hotInstance;o&&o.render()},Fe=e=>{e.key==="Enter"&&(e.preventDefault(),Q())};return O||k===void 0||_===void 0||p===void 0?t.jsx(Re,{}):t.jsxs("div",{className:"pt-5 relative",children:[t.jsx(ze,{...ne}),t.jsx(Ee,{...oe,onConfirm:Se,onClose:_e}),t.jsx("div",{className:"mb-4",children:re?t.jsxs("div",{className:`${F.card} p-4`,children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx(U,{children:x("input")}),t.jsx("textarea",{className:"w-full h-64 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500",value:R,onChange:e=>K(e.target.value),autoFocus:!0})]}),t.jsxs("div",{children:[t.jsx(U,{children:x("preview")}),t.jsx("div",{className:"prose dark:prose-invert max-w-none p-2 border rounded h-64 overflow-y-auto dark:bg-gray-700 dark:border-gray-600",children:t.jsx(ee,{children:R})})]})]}),t.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[t.jsx(q,{variant:"outlined",color:F.button.indigo,size:"sm",onClick:()=>J(!1),children:x("cancel")}),t.jsx(q,{color:F.button.indigo,onClick:pe,children:x("save")})]})]}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"relative",children:t.jsxs("div",{className:`${F.card} p-4 min-h-[4rem] cursor-pointer prose dark:prose-invert max-w-none`,onDoubleClick:ge,children:[V?t.jsx(ee,{children:V}):t.jsx("p",{className:"text-gray-400",children:x("double_click_to_edit_memo")}),t.jsx("button",{onClick:()=>ae(!Y),className:`${F.floatingActionButton} absolute bottom-4 right-2`,children:t.jsx(B.div,{animate:{rotate:Y?45:0},children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})})})]})})})}),t.jsxs("div",{className:"flex items-center justify-between pb-2",children:[t.jsx(Be,{inputRef:A,onKeyDown:Fe,onSearch:Q}),t.jsx(se,{children:Y&&t.jsx(B.div,{className:"absolute mb-5 buttom-0 right-0 z-180 flex flex-col items-end",initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},transition:{duration:.2,ease:"easeInOut"},children:t.jsx(Ye,{onInsert:xe,onDelete:$e,colorPalette:ce,textColorPalette:ie,handleColorClick:le,handleColorRightClick:de,handleTextColorClick:he,handleTextColorRightClick:ue,onCsvSave:fe,onSaveAll:X,onCopy:i?.uid===Oe?Ce:null})},"fab-menu")})]}),t.jsx("div",{className:"relative",children:t.jsx(Pe,{hotRef:u,search:P,columns:C,rowData:k,colorData:_,colorTextData:p,afterSelection:je,handleAfterColumnResize:De})})]})};export{Ke as MemoSheetGrid,Ke as default};

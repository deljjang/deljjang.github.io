import{j as t,bh as W,k as A,e as se,o as M,a1 as V,i as Te,I as Fe,g as Me,q as Ie,r as m,f as Re,b7 as k,bd as H,s as y,N as U,bI as Ae,aL as Oe,bJ as te,bC as Ee,m as Be,bK as Pe}from"./index-DJsI4Zxh.js";const Qe=({show:T,message:a,color:Q="green"})=>{const h=`bg-${Q}-500`;return t.jsx(W,{children:T&&t.jsx(A.div,{initial:{y:"-100%",opacity:0},animate:{y:0,opacity:1},exit:{y:"-100%",opacity:0},transition:{duration:.3,ease:"easeInOut"},className:`fixed top-50 left-1/2 -translate-x-1/2 z-[2000] p-3 rounded-lg shadow-lg ${h} text-white font-semibold`,children:a})})},Je=({onInsert:T,onDelete:a,onReload:Q,onCsvSave:h,onSaveAll:n,onCopy:g,colorPalette:j,textColorPalette:O,handleColorClick:f,handleColorRightClick:E,handleTextColorClick:w,handleTextColorRightClick:B})=>{const{t:N}=se(),C=[g&&{id:"copy",label:N("public"),onClick:g,color:"secondary"},{id:"csv",label:N("csv_save"),onClick:h,color:"sky"},{id:"save",label:N("save"),onClick:n,color:"sky"},{id:"delete",label:N("delete"),onClick:a,color:"warning"},{id:"insert",label:N("insert"),onClick:T,color:"sky"}].filter(Boolean),F={hidden:{opacity:0,y:10},visible:u=>({opacity:1,y:0,transition:{delay:u*.05,type:"spring",stiffness:300,damping:20}}),exit:u=>({opacity:0,y:10,transition:{delay:(C.length-u)*.05,duration:.1}})};return t.jsx(W,{children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx("div",{className:"flex flex-col items-end space-y-2 p-1 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:[C.slice(0,3),C.slice(3)].map((u,D)=>u.length>0&&t.jsx("div",{className:`${D===0?"flex items-center justify-end space-x-2":`w-full ${M.between}`}`,children:u.map((S,J)=>{const q=D*3+J;return t.jsx(A.div,{custom:q,variants:F,initial:"hidden",animate:"visible",exit:"exit",children:t.jsx(V,{size:"sm",color:S.color,onClick:S.onClick,children:S.label})},S.id)})},`group-${D}`))}),t.jsx("div",{children:t.jsx(A.div,{custom:1,variants:F,initial:"hidden",animate:"visible",exit:"exit",className:"p-2 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"flex items-center justify-end space-x-1",children:j.map(u=>t.jsx("div",{onClick:()=>f(u),onContextMenu:D=>E(D,u),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white",style:{backgroundColor:u}},`bg-${u}`))}),t.jsx("div",{className:"flex items-center justify-end space-x-1",children:O.map((u,D)=>t.jsx("div",{onClick:()=>w(u),onContextMenu:S=>B(S,u),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white flex items-center justify-center text-sm font-bold",style:{backgroundColor:"#fff",color:u},children:D%2===0?"A":"a"},`text-${u}`))})]})},"color-palettes")})]})})},ze=({detailData:T})=>{const{user:a}=Te(),{ui:Q}=Fe(),{t:h}=se(),{sheetId:n}=Me(),g=Ie(),[j,O]=m.useState([]),f=m.useRef(null),E=m.useRef(null),w=m.useRef(null),[B,N]=m.useState([]),[C,F]=m.useState(void 0),[u,D]=m.useState(void 0),[S,J]=m.useState(""),[q,z]=m.useState({isOpen:!1}),[oe,_]=m.useState({show:!1,message:""}),[L,G]=m.useState(""),[K,ae]=m.useState(!1),[ne,Y]=m.useState(!1),[P,X]=m.useState(""),re=["#FFADAD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF"],le=["#000000","#D00000","#AE4600","#006400","#00529B","#0018A8","#5A00A8","#A800A8"],ie=e=>{if(!f.current?.hotInstance||!w.current)return;const{row:s,col:l,row2:r,col2:d}=w.current,i=Math.min(s,r),c=Math.max(s,r),$=Math.min(l,d),v=Math.max(l,d),x=[...C];let R=!1;for(let p=i;p<=c;p++){x[p]||(x[p]=Array(j.length).fill(""));for(let b=$;b<=v;b++)x[p][b]!==e&&(x[p][b]=e,R=!0)}R&&F(x)},ce=(e,o)=>{e.preventDefault();const s=f.current?.hotInstance;if(!s)return;const l=s.countRows(),r=[...C];let d=!1;for(let i=0;i<l;i++)if(r[i])for(let c=0;c<r[i].length;c++)r[i][c]===o&&(r[i][c]=void 0,d=!0);d&&F(r)},de=e=>{if(!f.current?.hotInstance||!w.current)return;const{row:s,col:l,row2:r,col2:d}=w.current,i=Math.min(s,r),c=Math.max(s,r),$=Math.min(l,d),v=Math.max(l,d),x=[...u];let R=!1;for(let p=i;p<=c;p++){x[p]||(x[p]=Array(j.length).fill(void 0));for(let b=$;b<=v;b++)x[p][b]!==e&&(x[p][b]=e,R=!0)}R&&D(x)},ue=(e,o)=>{e.preventDefault();const s=f.current?.hotInstance;if(!s)return;const l=s.countRows(),r=[...u];let d=!1;for(let i=0;i<l;i++)if(r[i])for(let c=0;c<r[i].length;c++)r[i][c]===o&&(r[i][c]=void 0,d=!0);d&&D(r)},{data:I,isLoading:he}=Re({queryKey:["sheetData",n,a?.uid],queryFn:async()=>{if(!n||!a)return{rowData:[],colorData:[],colorTextData:[]};const e=`memo_sheet_data/${a?.uid}/${n}/data`,o=`memo_sheet_data/${a?.uid}/${n}/color`,s=`memo_sheet_data/${a?.uid}/${n}/textColor`,[l,r,d]=await Promise.all([k(e),k(o),k(s)]),i=l?Object.values(l).map(v=>typeof v=="string"?JSON.parse(v):v):[],c=r?Object.values(r).map(v=>JSON.parse(v)):[],$=d?Object.values(d).map(v=>JSON.parse(v)):[];return{rowData:i,colorData:c,colorTextData:$}},enabled:!!n&&!!a&&j.length>0,staleTime:1e3*60*5});m.useEffect(()=>{I&&(N(I.rowData),F(I.colorData),D(I.colorTextData))},[I]);function me(){const e=T?.scrollY?T.scrollY:0;window.scrollTo({top:e})}m.useEffect(()=>{n&&a&&(k(`memo_sheet/${a?.uid}/${n}/columns`).then(e=>{O(e||[{title:"title",data:"title",type:"text"}])}),k(`memo_sheet_data/${a?.uid}/${n}/memo`).then(e=>{G(e||"")}),me())},[n,a]);const fe=async()=>{f.current.hotInstance.getPlugin("exportFile").downloadFile("csv",{filename:`sheet_${n}`,mimeType:"text/csv",bom:!1,columnDelimiter:",",rowDelimiter:`\r
`})};async function xe(){const e=f.current?.hotInstance;if(!e)return;let o;if(w.current&&w.current.row>=0){const s=w.current.row;o=s+1,e.alter("insert_row_below",s,1)}else o=0,e.alter("insert_row_above",0,1);e.selectCell(o,0)}const{mutate:we}=H({mutationFn:async({rowsDB:e,bgColorDataToSave:o,textColorDataToSave:s})=>{await ve(e,o,s)},onMutate:async({rowsDB:e,bgColorDataToSave:o,textColorDataToSave:s})=>{await g.cancelQueries({queryKey:["sheetData",n,a?.uid]});const l=g.getQueryData(["sheetData",n,a?.uid]),r=e.map(c=>JSON.parse(c)),d=o.map(c=>JSON.parse(c)),i=s.map(c=>JSON.parse(c));return g.setQueryData(["sheetData",n,a?.uid],c=>({...c,rowData:r,colorData:d,colorTextData:i})),{previousSheetData:l}},onError:(e,o,s)=>{s?.previousSheetData&&g.setQueryData(["sheetData",n,a?.uid],s.previousSheetData)},onSuccess:()=>{_({show:!0,message:h("save_completed")}),setTimeout(()=>_({show:!1,message:""}),2e3)},onSettled:()=>{g.invalidateQueries({queryKey:["sheetData",n,a?.uid]})}}),pe=async()=>{y(`memo_sheet_data/${a?.uid}/${n}/memo`,P),G(P),Y(!1)},ge=()=>{X(L),Y(!0)},ve=(e,o,s)=>{y(`memo_sheet_data/${a?.uid}/${n}/data`,null),e.map((l,r)=>{y(`memo_sheet_data/${a?.uid}/${n}/data/${r}`,l)}),y(`memo_sheet_data/${a?.uid}/${n}/color`,o),y(`memo_sheet_data/${a?.uid}/${n}/textColor`,s),y(`memo_sheet/${a?.uid}/${n}/createdAt`,Date.now()),y(`memo_sheet/${a?.uid}/${n}/count`,e.length)},De=H({mutationFn:async()=>{if(!a||!n)throw new Error("User or Sheet ID is missing.");const e=`memo_sheet/${a.uid}/${n}`,o=`memo_sheet_data/${a.uid}/${n}`,[s,l]=await Promise.all([k(e),k(o)]);if(console.log("sheetMeta=",s),console.log("sheetData=",l),!s)throw new Error("Sheet metadata not found.");const r=await k(`home_txt/${n}`);console.log("data=",r);const d={title:r?.title||s.title,color:l?.color||[],columns:s.columns||[],createdAt:s.createdAt||Date.now(),data:l?.data||[],gbn:r?.gbn||"etc",html:"sheet",memo:r?.memo||l?.memo||"",textColor:l?.textColor||[]};await y(`${e}/public`,"Y"),await y(`home_txt/${n}`,d),await y(`home_txt/${n}`,d)},onSuccess:()=>{Ce(h("copy_completed"))},onError:e=>{console.error("Copy failed:",e);const o=`${h("copy_failed")} ${e.message?`: ${e.message}`:""}`;_({show:!0,message:o}),setTimeout(()=>_({show:!1,message:""}),3e3)}}),ye=()=>{De.mutate()},Ce=e=>{_({show:!0,message:e}),setTimeout(()=>_({show:!1,message:""}),2e3)},Z=async(e=!0)=>{const o=f.current?.hotInstance;if(!o)return;const s=o.getSourceData(),l=[];s.forEach((i,c)=>{i.id=c;const $=[];j.forEach((v,x)=>{$.push(i[x]?i[x]:"")}),l.push(JSON.stringify($))});const r=C.map(i=>JSON.stringify(i||[])),d=u.map(i=>JSON.stringify(i||[]));console.log("rowData=",l),console.log("bgColorDataToSave=",r),console.log("textColorDataToSave=",d),we({rowsDB:l,bgColorDataToSave:r,textColorDataToSave:d})},be=(e,o,s,l)=>{w.current={row:e,col:o,row2:s,col2:l}},je=async(e,o,s)=>{Z(!1);const l=f.current?.hotInstance;if(!l)return;const r=j.map((d,i)=>({...d,width:l.getColWidth(i)}));O(r),y(`memo_sheet/${a?.uid}/${n}/columns`,r)},{mutate:Se}=H({mutationFn:async e=>e,onMutate:async e=>{await g.cancelQueries({queryKey:["sheetData",n,a?.uid]});const o=g.getQueryData(["sheetData",n,a?.uid]);return g.setQueryData(["sheetData",n,a?.uid],s=>{const l=[...s.rowData];return l.splice(e,1),{...s,rowData:l}}),f.current?.hotInstance.alter("remove_row",e,1),w.current=null,{previousSheetData:o}},onError:(e,o,s)=>{g.setQueryData(["sheetData",n,a?.uid],s.previousSheetData)},onSettled:()=>{}}),_e=()=>{z({isOpen:!1})},$e=()=>{f.current.hotInstance;const e=w.current.row;console.log("onDelete=",e),z({isOpen:!1}),Se(e)},ke=async()=>{if(w.current&&f.current?.hotInstance){const e=h("delete_confirm_title"),o=h("delete_confirm_message_simple");z({isOpen:!0,title:e,message:o,color:"warning"})}else _({show:!0,message:h("select_row_to_delete")}),setTimeout(()=>{_({show:!1,message:""})},2e3)};if(a===void 0)return t.jsx("div",{className:"flex flex-col items-center justify-center h-full w-full mt-50",children:t.jsx(U,{children:h("login_required")})});const ee=()=>{const e=E.current.value;J(e);const o=f.current?.hotInstance;o&&o.render()},Ne=e=>{e.key==="Enter"&&(e.preventDefault(),ee())};return he||B===void 0||C===void 0||u===void 0?t.jsx(Ae,{}):t.jsxs("div",{className:"pt-5 relative",children:[t.jsx(Qe,{...oe}),t.jsx(Oe,{...q,onConfirm:$e,onClose:_e}),t.jsx("div",{className:"mb-4",children:ne?t.jsxs("div",{className:`${M.card} p-4`,children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx(U,{children:h("input")}),t.jsx("textarea",{className:"w-full h-64 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500",value:P,onChange:e=>X(e.target.value),autoFocus:!0})]}),t.jsxs("div",{children:[t.jsx(U,{children:h("preview")}),t.jsx("div",{className:"prose dark:prose-invert max-w-none p-2 border rounded h-64 overflow-y-auto dark:bg-gray-700 dark:border-gray-600",children:t.jsx(te,{children:P})})]})]}),t.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[t.jsx(V,{variant:"outlined",color:M.button.indigo,size:"sm",onClick:()=>Y(!1),children:h("cancel")}),t.jsx(V,{color:M.button.indigo,onClick:pe,children:h("save")})]})]}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"relative",children:t.jsxs("div",{className:`${M.card} p-4 min-h-[4rem] cursor-pointer prose dark:prose-invert max-w-none`,onDoubleClick:ge,children:[L?t.jsx(te,{children:L}):t.jsx("p",{className:"text-gray-400",children:h("double_click_to_edit_memo")}),t.jsx("button",{onClick:()=>ae(!K),className:`${M.floatingActionButton} absolute bottom-4 right-2`,children:t.jsx(A.div,{animate:{rotate:K?45:0},children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})})})]})})})}),t.jsxs("div",{className:"flex items-center justify-between pb-2",children:[t.jsx(Ee,{inputRef:E,onKeyDown:Ne,onSearch:ee}),t.jsx(W,{children:K&&t.jsx(A.div,{className:"absolute mb-5 buttom-0 right-0 z-180 flex flex-col items-end",initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},transition:{duration:.2,ease:"easeInOut"},children:t.jsx(Je,{onInsert:xe,onDelete:ke,colorPalette:re,textColorPalette:le,handleColorClick:ie,handleColorRightClick:ce,handleTextColorClick:de,handleTextColorRightClick:ue,onCsvSave:fe,onSaveAll:Z,onCopy:a?.uid===Be?ye:null})},"fab-menu")})]}),t.jsx("div",{className:"relative",children:t.jsx(Pe,{hotRef:f,search:S,columns:j,rowData:B,colorData:C,colorTextData:u,afterSelection:be,handleAfterColumnResize:je})})]})};export{ze as MemoSheetGrid,ze as default};

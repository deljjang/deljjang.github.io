import{r as h,j as t}from"./index-D_uTceCe.js";import{c as K,a1 as Q,M as X,a5 as D,a4 as ee,aH as te,k,a0 as ae,c6 as se,c7 as le,c8 as L,c9 as ne,ab as P,i as oe,l as ie,h as re,a as ce,e as de,V as me,L as U,c3 as ue,bu as ge}from"./App-ai_KYhla.js";import{T as he}from"./TwTextArea-SUPC2JEl.js";import{T as xe,D as fe,H as ve}from"./HtmlBadge-BQNM1wtT.js";import{u as pe,a as we,b as ye}from"./MemoComm-DgQTxP-Q.js";import"./IpInfo-BU2oiB25.js";import"./angle-right-vkfnkFu_.js";const je=l=>{const[m,d]=h.useState(l.imageList),[o,r]=h.useState(l.content),{t:s}=K(),[n,y]=h.useState(),x=h.useRef(),F=h.useRef(!1),c=h.useRef(null),f=h.useRef([]),{height:T}=Q(),g={edTitle:l.title,edGbn:l.gbn?l.gbn:"etc",edDate:l.date,content:l.content,memoTxt:l.content,htmlCheck:"N",iconCheck:"N"},{register:C,handleSubmit:$,trigger:ke,control:j,setValue:v,getValues:b,watch:Te,formState:{errors:Ce,isSubmitting:Ne}}=X({mode:"onChange",defaultValues:g});h.useEffect(()=>{C("edDate"),C("memoTxt")},[]),h.useEffect(()=>{f.current=[],x.current=l.content},[l.content]);const S=async e=>{await l.onPostSubmit(e,m,f.current)},I=()=>{$(S)()},R=e=>{d(e)},B=e=>{let a=x.current;e.ext==="jpg"||e.ext==="png"?(a+=`<img src='${e.url}'/>`,p(`<img src='${e.url}'/>
`)):e.ext==="mp4"?(a+=`<video preload="auto" controls="" src='${e.url}'></video>`,p(`<video preload="auto" controls="" src='${e.url}'></video>`)):(a+=`<a src='${e.url}'>${e.name}}</a>`,p(`${s("download_link_text")}
<a href="${e.url}" target="_blank">${e.name}</a>
`)),x.current=a},A=e=>l.onRename(e,b("edTitle")),Y=e=>{x.current=e},H=e=>{f.current=e};function M(e){p(`<img src='${e}'/>`)}function V(){let e="";m&&m.length>0&&m.map((a,i)=>{e+=`<img src="/data/memo/${a.key}.${a.ext}" style="width: 50px;"/>
`}),e!==""&&p(e)}const q=[{value:"none",label:s("none")},{value:"react",label:s("react")},{value:"css",label:s("css")},{value:"android",label:s("android")},{value:"java",label:s("java")},{value:"image",label:s("image")},{value:"etc",label:s("etc")},{value:"mui",label:s("mui")}],p=e=>{const a=c.current;if(a){const i=a.selectionStart,u=a.selectionEnd,w=o.slice(0,i),N=o.slice(u);r(w+e+N),v("memoTxt",w+e+N),setTimeout(()=>{a.selectionStart=a.selectionEnd=i+e.length,a.focus()},100)}},O=e=>{p(e)},G=e=>e?/\.(jpg|jpeg|png|gif|bmp|webp|svg)/i.test(e)||e.includes("image")||e.includes("img"):!1,z=async()=>{await se("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1")},J=async()=>{const e=await le("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1");let a="";e.map(i=>{a+=i+`
`}),p(a)},Z=async()=>{const e=b("edFilePath");if(e===""){const a=[];let i=c.current.value;i=i.replace(/<img src="\/data\/memo\//g,""),i=i.replace(/ style="width: 50px;"/g,""),i=i.replace(/"\/>/g,""),i=i.replace(/ /g,""),i.split(`
`).forEach(async u=>{u.indexOf(".")>0&&a.push(u)}),a.length>0&&await l.onFilePathList(a)}else await l.onFilePath(e)},W=e=>new Promise((a,i)=>{const u=new Image;u.crossOrigin="anonymous",u.onload=()=>{const w=document.createElement("canvas"),N=w.getContext("2d");w.width=u.width,w.height=u.height,N.drawImage(u,0,0);try{const _=w.toDataURL("image/png");a(_)}catch(_){i(_)}},u.onerror=()=>{i(new Error("Failed to load image"))},u.src=e});return t.jsx("div",{className:"my-2 mb-[50px], w-full",children:t.jsxs("form",{onSubmit:$(S),style:{width:"100%",minHeight:"300px",maxHeight:{height:T},display:"flex",flexDirection:"column"},children:[t.jsx(xe,{onSubmit:e=>I(),onCancel:l.onCancel,isSubmitting:F.current}),t.jsx(fe,{control:j,onDelete:R,onInsert:B,onRename:A,setContent:Y,onFileUpload:H,imageList:l.imageList}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{className:"w-full",children:t.jsx(D,{name:"edTitle",placeholder:s("title_placeholder"),control:j,className:"w-full",rules:{required:s("required_field"),minLength:{value:2,message:s("min_length_2")}},onChange:e=>{e.preventDefault(),v("edTitle",e.target.value)}})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(ee,{name:"edGbn",label:s("category"),control:j,rules:{required:!0},placeholder:s("category_placeholder"),options:q,className:"",allClassName:"max-w-40",onChange:e=>{e.preventDefault();const a=e.target.value;v("edGbn",a)}}),t.jsx(te,{id:"edDate",name:"edDate",placeholder:s("select_date_placeholder"),control:j,onChange:(e,a)=>{v("edDate",a)}})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(D,{name:"edUrl",placeholder:s("base64_url_placeholder"),control:j,className:"w-full",allClassName:"w-full",onChange:e=>{e.preventDefault();const a=e.target.value;v("edUrl",a),y(a)}}),t.jsx(k,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),M(b("edUrl2"))},children:s("apply")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(D,{name:"edUrl2",placeholder:s("base64_image_data_placeholder"),className:"w-full",allClassName:"w-full",variant:"filled",size:"md",value:b("edUrl2")||""}),t.jsx(k,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),V()},children:s("add_attachment")})]}),t.jsxs("div",{className:"flex gap-2 w-full",children:[t.jsx(D,{name:"edFilePath",placeholder:s("add_to_imagelist_placeholder"),className:"w-full",allClassName:"w-full",control:j,onChange:e=>{e.preventDefault();const a=e.target.value;v("edFilePath",a)}}),t.jsx(k,{size:"sm",variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),Z()},children:s("file_path")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(k,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),z()},children:s("all_files")}),t.jsx(k,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),J()},children:s("all_files_10")})]})]}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{children:t.jsx("div",{className:"max-h-100 overflow-y-scroll",children:t.jsx(ae,{postData:o})})}),t.jsx("div",{children:t.jsx(he,{ref:c,className:"",value:o,onChange:e=>{v("memoTxt",e),r(e)},rows:20})}),b("edUrl")&&G(b("edUrl"))&&t.jsx("div",{className:"mt-2 p-2 border border-gray-300 dark:border-gray-600 rounded",children:t.jsx("img",{src:n,alt:s("preview"),className:"max-w-full h-auto max-h-48 object-contain",onLoad:async e=>{try{const a=await W(n);v("edUrl2",a)}catch(a){console.error("Base64 conversion failed:",a)}},onError:e=>{e.target.style.display="none"}})})]}),t.jsx(ve,{onClick:O}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"})]})})},be=async(l,m,d,o,r)=>{const s=l==="memo"?`${l}/${m.uid}/`:`${l}/`,n=await ne(s,o.key,r,o.ext);if(n.success){const y=l==="memo"?`memo_txt/${m.uid}/${d}/image/`:`home_txt/${d}/image/`;P(y+o.key,null);const x={...o,key:n.key,url:n.url,name:`${n.key}.${o.ext}`};return P(y+n.key,x),x}},E=async(l,m,d)=>{if(Array.isArray(d)&&d.length>0)for(const o of d)try{await L(l,m,o)}catch(r){console.error(`Error getting path for ${o}:`,r)}else typeof d=="string"&&await L(l,m,d)},Ue=({rootDb:l})=>{const{scrollYProgress:m}=pe();we(m,{stiffness:100,damping:30,restDelta:.001});const d=oe(),{user:o}=ie(),{memoId:r}=re();ce();const s=de(),{memoDetailData:n,isLoading:y}=ye(l,o,r);console.log("MemoDetailEdit.title=",n?.title);const x=()=>{const c=`/${l==="memo"?"m":l}/${r==="insert"?"":r}`;d(c)},F=(c,f,T)=>{s(ue({rootDb:l,memoId:r,values:c,imageList:f,files:T,user:o})).unwrap().then(g=>{s({type:"tabs/updateTabTitle",payload:{id:g.key,title:g.title}}),s({type:"bookmark/updateBookmarkTitle",payload:{id:g.key,title:g.title}}),s(ge({id:g.key,newTitle:g.title}));const C=`/${g.rootDb==="memo"?"m":g.rootDb}/${g.key}`;d(C,{state:{reflash:!0}})})};return h.useEffect(()=>{n&&n.title!==void 0&&me({title:n.title,description:n.title});function c(){document.querySelectorAll("pre").forEach((f,T)=>{})}n&&n.memo!==null&&c()},[n]),r===""||o===void 0?t.jsx(t.Fragment,{}):n===void 0||y?t.jsx(U,{}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"w-full p-0 m-0",children:n&&(n.title===void 0||n.title===""||n.title===null)?t.jsx(U,{}):t.jsx(je,{onPostSubmit:F,onCancel:x,onRename:(c,f)=>be(l,o,r,c,f),onFilePath:c=>E(o.uid,r,c),onFilePathList:c=>E(o.uid,r,c),title:n?.title,gbn:n?.gbn,date:n?.date,htmlCheck:n?.html?n?.html==="Y"?"Y":"N":"Y",iconCheck:!n?.icon==="Y"?"Y":"N",content:n?.memo,imageList:n?.image})})})};export{Ue as MemoDetailUtil,Ue as default};

import{j as t}from"./index-BvNkBfum.js";import{bp as K,p as T,b as te,q as I,h as H,i as Fe,c as Ie,e as Z,bP as Ne,bQ as Me,bR as Te,K as Y,bS as Re,aC as Ae,bT as ee,bL as Ee,m as Be,bU as Oe,a6 as v,b1 as q,bV as Pe}from"./App-BcbvFi9F.js";import{c as ze,r as h}from"./router-v4BRDFYV.js";import"./vendor-CCYiWZgt.js";const Le=({show:$,message:i,color:u="green"})=>{const r=`bg-${u}-500`;return t.jsx(K,{children:$&&t.jsx(T.div,{initial:{y:"-100%",opacity:0},animate:{y:0,opacity:1},exit:{y:"-100%",opacity:0},transition:{duration:.3,ease:"easeInOut"},className:`fixed top-50 left-1/2 -translate-x-1/2 z-[2000] p-3 rounded-lg shadow-lg ${r} text-white font-semibold`,children:i})})},Je=({onInsert:$,onDelete:i,onReload:u,onCsvSave:r,onSaveAll:j,onCopy:D,colorPalette:O,textColorPalette:y,handleColorClick:R,handleColorRightClick:m,handleTextColorClick:A,handleTextColorRightClick:w})=>{const{t:k}=te(),N=[D&&{id:"copy",label:k("public"),onClick:D,color:"secondary"},{id:"csv",label:k("csv_save"),onClick:r,color:"sky"},{id:"save",label:k("save"),onClick:j,color:"sky"},{id:"delete",label:k("delete"),onClick:i,color:"warning"},{id:"insert",label:k("insert"),onClick:$,color:"sky"}].filter(Boolean),_={hidden:{opacity:0,y:10},visible:c=>({opacity:1,y:0,transition:{delay:c*.05,type:"spring",stiffness:300,damping:20}}),exit:c=>({opacity:0,y:10,transition:{delay:(N.length-c)*.05,duration:.1}})};return t.jsx(K,{children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx("div",{className:"flex flex-col items-end space-y-2 p-1 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:[N.slice(0,3),N.slice(3)].map((c,g)=>c.length>0&&t.jsx("div",{className:`${g===0?"flex items-center justify-end space-x-2":`w-full ${I.between}`}`,children:c.map((b,P)=>{const z=g*3+P;return t.jsx(T.div,{custom:z,variants:_,initial:"hidden",animate:"visible",exit:"exit",children:t.jsx(H,{size:"sm",color:b.color,onClick:b.onClick,children:b.label})},b.id)})},`group-${g}`))}),t.jsx("div",{children:t.jsx(T.div,{custom:1,variants:_,initial:"hidden",animate:"visible",exit:"exit",className:"p-2 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"flex items-center justify-end space-x-1",children:O.map(c=>t.jsx("div",{onClick:()=>R(c),onContextMenu:g=>m(g,c),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white",style:{backgroundColor:c}},`bg-${c}`))}),t.jsx("div",{className:"flex items-center justify-end space-x-1",children:y.map((c,g)=>t.jsx("div",{onClick:()=>A(c),onContextMenu:b=>w(b,c),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white flex items-center justify-center text-sm font-bold",style:{backgroundColor:"#fff",color:c},children:g%2===0?"A":"a"},`text-${c}`))})]})},"color-palettes")})]})})},He=({detailData:$})=>{const{user:i}=Fe(),{t:u}=te(),{sheetId:r}=ze(),j=Ie(),D=Z(e=>e.sheet.sheetData),O=Z(e=>e.sheet.isLoading),[y,R]=h.useState([]),m=h.useRef(null),A=h.useRef(null),w=h.useRef(null),[k,N]=h.useState([]),[_,c]=h.useState(void 0),[g,b]=h.useState(void 0),[P,z]=h.useState(""),[se,L]=h.useState({isOpen:!1}),[oe,S]=h.useState({show:!1,message:""}),[J,W]=h.useState(""),[U,ne]=h.useState(!1),[ae,V]=h.useState(!1),[E,G]=h.useState(""),re=["#FFADAD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF"],le=["#000000","#D00000","#AE4600","#006400","#00529B","#0018A8","#5A00A8","#A800A8"],ie=e=>{if(!m.current?.hotInstance||!w.current)return;const{row:s,col:a,row2:o,col2:d}=w.current,l=Math.min(s,o),f=Math.max(s,o),F=Math.min(a,d),B=Math.max(a,d),x=[..._];let M=!1;for(let p=l;p<=f;p++){x[p]||(x[p]=Array(y.length).fill(""));for(let C=F;C<=B;C++)x[p][C]!==e&&(x[p][C]=e,M=!0)}M&&c(x)},ce=(e,n)=>{e.preventDefault();const s=m.current?.hotInstance;if(!s)return;const a=s.countRows(),o=[..._];let d=!1;for(let l=0;l<a;l++)if(o[l])for(let f=0;f<o[l].length;f++)o[l][f]===n&&(o[l][f]=void 0,d=!0);d&&c(o)},de=e=>{if(!m.current?.hotInstance||!w.current)return;const{row:s,col:a,row2:o,col2:d}=w.current,l=Math.min(s,o),f=Math.max(s,o),F=Math.min(a,d),B=Math.max(a,d),x=[...g];let M=!1;for(let p=l;p<=f;p++){x[p]||(x[p]=Array(y.length).fill(void 0));for(let C=F;C<=B;C++)x[p][C]!==e&&(x[p][C]=e,M=!0)}M&&b(x)},he=(e,n)=>{e.preventDefault();const s=m.current?.hotInstance;if(!s)return;const a=s.countRows(),o=[...g];let d=!1;for(let l=0;l<a;l++)if(o[l])for(let f=0;f<o[l].length;f++)o[l][f]===n&&(o[l][f]=void 0,d=!0);d&&b(o)};h.useEffect(()=>{r&&i&&y.length>0&&j(Ne({sheetId:r,userId:i.uid}))},[r,i,y.length,j]),h.useEffect(()=>{D&&(N(D.rowData),c(D.colorData),b(D.colorTextData))},[D]);function ue(){const e=$?.scrollY?$.scrollY:0;window.scrollTo({top:e})}h.useEffect(()=>{r&&i&&(j(Me({sheetId:r,userId:i.uid})).then(e=>{R(e.payload)}),j(Te({sheetId:r,userId:i.uid})).then(e=>{W(e.payload)}),ue())},[r,i,j]);const me=async()=>{m.current.hotInstance.getPlugin("exportFile").downloadFile("csv",{filename:`sheet_${r}`,mimeType:"text/csv",bom:!1,columnDelimiter:",",rowDelimiter:`\r
`})};async function fe(){const e=m.current?.hotInstance;if(!e)return;let n;if(w.current&&w.current.row>=0){const s=w.current.row;n=s+1,e.alter("insert_row_below",s,1)}else n=0,e.alter("insert_row_above",0,1);e.selectCell(n,0)}const xe=async({rowsDB:e,bgColorDataToSave:n,textColorDataToSave:s})=>{try{await pe(e,n,s),await j(Pe({userId:i.uid,sheetId:r,rowsDB:e,bgColorDataToSave:n,textColorDataToSave:s})),S({show:!0,message:u("save_completed")}),setTimeout(()=>S({show:!1,message:""}),2e3)}catch(a){console.error("Save failed:",a)}},we=async()=>{v(`memo_sheet_data/${i?.uid}/${r}/memo`,E),W(E),V(!1)},ge=()=>{G(J),V(!0)},pe=(e,n,s)=>{v(`memo_sheet_data/${i?.uid}/${r}/data`,null),e.map((a,o)=>{v(`memo_sheet_data/${i?.uid}/${r}/data/${o}`,a)}),v(`memo_sheet_data/${i?.uid}/${r}/color`,n),v(`memo_sheet_data/${i?.uid}/${r}/textColor`,s),v(`memo_sheet/${i?.uid}/${r}/createdAt`,Date.now()),v(`memo_sheet/${i?.uid}/${r}/count`,e.length)},ve=async()=>{try{if(!i||!r)throw new Error("User or Sheet ID is missing.");const e=`memo_sheet/${i.uid}/${r}`,n=`memo_sheet_data/${i.uid}/${r}`,[s,a]=await Promise.all([q(e),q(n)]);if(console.log("sheetMeta=",s),console.log("sheetData=",a),!s)throw new Error("Sheet metadata not found.");const o=await q(`home_txt/${r}`);console.log("data=",o);const d={title:o?.title||s.title,color:a?.color||[],columns:s.columns||[],createdAt:s.createdAt||Date.now(),data:a?.data||[],gbn:o?.gbn||"etc",html:"sheet",memo:o?.memo||a?.memo||"",textColor:a?.textColor||[]};await v(`${e}/public`,"Y"),await v(`home_txt/${r}`,d),await v(`home_txt/${r}`,d),ye(u("copy_completed"))}catch(e){console.error("Copy failed:",e);const n=`${u("copy_failed")} ${e.message?`: ${e.message}`:""}`;S({show:!0,message:n}),setTimeout(()=>S({show:!1,message:""}),3e3)}},be=()=>{ve()},ye=e=>{S({show:!0,message:e}),setTimeout(()=>S({show:!1,message:""}),2e3)},Q=async(e=!0)=>{const n=m.current?.hotInstance;if(!n)return;const s=n.getSourceData(),a=[];s.forEach((l,f)=>{l.id=f;const F=[];y.forEach((B,x)=>{F.push(l[x]?l[x]:"")}),a.push(JSON.stringify(F))});const o=_.map(l=>JSON.stringify(l||[])),d=g.map(l=>JSON.stringify(l||[]));console.log("rowData=",a),console.log("bgColorDataToSave=",o),console.log("textColorDataToSave=",d),xe({rowsDB:a,bgColorDataToSave:o,textColorDataToSave:d})},Ce=(e,n,s,a)=>{w.current={row:e,col:n,row2:s,col2:a}},je=async(e,n,s)=>{Q(!1);const a=m.current?.hotInstance;if(!a)return;const o=y.map((d,l)=>({...d,width:a.getColWidth(l)}));R(o),v(`memo_sheet/${i?.uid}/${r}/columns`,o)},De=e=>{m.current?.hotInstance.alter("remove_row",e,1),w.current=null},ke=()=>{L({isOpen:!1})},_e=()=>{m.current.hotInstance;const e=w.current.row;console.log("onDelete=",e),L({isOpen:!1}),De(e)},Se=async()=>{if(w.current&&m.current?.hotInstance){const e=u("delete_confirm_title"),n=u("delete_confirm_message_simple");L({isOpen:!0,title:e,message:n,color:"warning"})}else S({show:!0,message:u("select_row_to_delete")}),setTimeout(()=>{S({show:!1,message:""})},2e3)};if(i===void 0)return t.jsx("div",{className:"flex flex-col items-center justify-center h-full w-full mt-50",children:t.jsx(Y,{children:u("login_required")})});const X=()=>{const e=A.current.value;z(e);const n=m.current?.hotInstance;n&&n.render()},$e=e=>{e.key==="Enter"&&(e.preventDefault(),X())};return O||k===void 0||_===void 0||g===void 0?t.jsx(Re,{}):t.jsxs("div",{className:"pt-5 relative",children:[t.jsx(Le,{...oe}),t.jsx(Ae,{...se,onConfirm:_e,onClose:ke}),t.jsx("div",{className:"mb-4",children:ae?t.jsxs("div",{className:`${I.card} p-4`,children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx(Y,{children:u("input")}),t.jsx("textarea",{className:"w-full h-64 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500",value:E,onChange:e=>G(e.target.value),autoFocus:!0})]}),t.jsxs("div",{children:[t.jsx(Y,{children:u("preview")}),t.jsx("div",{className:"prose dark:prose-invert max-w-none p-2 border rounded h-64 overflow-y-auto dark:bg-gray-700 dark:border-gray-600",children:t.jsx(ee,{children:E})})]})]}),t.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[t.jsx(H,{variant:"outlined",color:I.button.indigo,size:"sm",onClick:()=>V(!1),children:u("cancel")}),t.jsx(H,{color:I.button.indigo,onClick:we,children:u("save")})]})]}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"relative",children:t.jsxs("div",{className:`${I.card} p-4 min-h-[4rem] cursor-pointer prose dark:prose-invert max-w-none`,onDoubleClick:ge,children:[J?t.jsx(ee,{children:J}):t.jsx("p",{className:"text-gray-400",children:u("double_click_to_edit_memo")}),t.jsx("button",{onClick:()=>ne(!U),className:`${I.floatingActionButton} absolute bottom-4 right-2`,children:t.jsx(T.div,{animate:{rotate:U?45:0},children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})})})]})})})}),t.jsxs("div",{className:"flex items-center justify-between pb-2",children:[t.jsx(Ee,{inputRef:A,onKeyDown:$e,onSearch:X}),t.jsx(K,{children:U&&t.jsx(T.div,{className:"absolute mb-5 buttom-0 right-0 z-180 flex flex-col items-end",initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},transition:{duration:.2,ease:"easeInOut"},children:t.jsx(Je,{onInsert:fe,onDelete:Se,colorPalette:re,textColorPalette:le,handleColorClick:ie,handleColorRightClick:ce,handleTextColorClick:de,handleTextColorRightClick:he,onCsvSave:me,onSaveAll:Q,onCopy:i?.uid===Be?be:null})},"fab-menu")})]}),t.jsx("div",{className:"relative",children:t.jsx(Oe,{hotRef:m,search:P,columns:y,rowData:k,colorData:_,colorTextData:g,afterSelection:Ce,handleAfterColumnResize:je})})]})};export{He as MemoSheetGrid,He as default};

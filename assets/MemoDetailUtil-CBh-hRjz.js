import{j as t}from"./index-Ck2d_L_e.js";import{g as X,N as K,a1 as D,n as T,$ as Q,cX as ee,cY as te,cZ as L,c_ as ae,a8 as U,o as se,h as le,cj as ne,s as oe,b as P,cU as ie,cm as re}from"./App--a2e3x7R.js";import{r as h,a as ce,c as me,u as de}from"./router-BlMcuVHC.js";import{u as ue}from"./useWindowDimensions-c3RsCB5T.js";import{T as ge}from"./TwTextArea-yUnbwluH.js";import{T as he}from"./TwDatePicker-CS_I1-sS.js";import{T as xe}from"./TwSelect-CNt8UIub.js";import{T as fe,D as ve,H as pe}from"./HtmlBadge-Okzm3icP.js";import{u as we,a as ye}from"./MemoComm-CQWhjXQP.js";import"./vendor-CCYiWZgt.js";import"./IpInfo-DWVB1yYn.js";const je=l=>{const[d,m]=h.useState(l.imageList),[o,r]=h.useState(l.content),{t:s}=X(),[n,y]=h.useState(),x=h.useRef(),_=h.useRef(!1),c=h.useRef(null),f=h.useRef([]),{height:k}=ue(),g={edTitle:l.title,edGbn:l.gbn?l.gbn:"etc",edDate:l.date,content:l.content,memoTxt:l.content,htmlCheck:"N",iconCheck:"N"},{register:N,handleSubmit:F,trigger:Te,control:j,setValue:v,getValues:b,watch:ke,formState:{errors:Ne,isSubmitting:Ce}}=K({mode:"onChange",defaultValues:g});h.useEffect(()=>{N("edDate"),N("memoTxt")},[]),h.useEffect(()=>{f.current=[],x.current=l.content},[l.content]);const S=async e=>{await l.onPostSubmit(e,d,f.current)},I=()=>{F(S)()},R=e=>{m(e)},B=e=>{let a=x.current;e.ext==="jpg"||e.ext==="png"?(a+=`<img src='${e.url}'/>`,p(`<img src='${e.url}'/>
`)):e.ext==="mp4"?(a+=`<video preload="auto" controls="" src='${e.url}'></video>`,p(`<video preload="auto" controls="" src='${e.url}'></video>`)):(a+=`<a src='${e.url}'>${e.name}}</a>`,p(`${s("download_link_text")}
<a href="${e.url}" target="_blank">${e.name}</a>
`)),x.current=a},A=e=>l.onRename(e,b("edTitle")),Y=e=>{x.current=e},M=e=>{f.current=e};function H(e){p(`<img src='${e}'/>`)}function q(){let e="";d&&d.length>0&&d.map((a,i)=>{e+=`<img src="/data/memo/${a.key}.${a.ext}" style="width: 50px;"/>
`}),e!==""&&p(e)}const O=[{value:"none",label:s("none")},{value:"react",label:s("react")},{value:"css",label:s("css")},{value:"android",label:s("android")},{value:"java",label:s("java")},{value:"image",label:s("image")},{value:"etc",label:s("etc")},{value:"mui",label:s("mui")}],p=e=>{const a=c.current;if(a){const i=a.selectionStart,u=a.selectionEnd,w=o.slice(0,i),C=o.slice(u);r(w+e+C),v("memoTxt",w+e+C),setTimeout(()=>{a.selectionStart=a.selectionEnd=i+e.length,a.focus()},100)}},V=e=>{p(e)},G=e=>e?/\.(jpg|jpeg|png|gif|bmp|webp|svg)/i.test(e)||e.includes("image")||e.includes("img"):!1,Z=async()=>{await ee("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1")},z=async()=>{const e=await te("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1");let a="";e.map(i=>{a+=i+`
`}),p(a)},J=async()=>{const e=b("edFilePath");if(e===""){const a=[];let i=c.current.value;i=i.replace(/<img src="\/data\/memo\//g,""),i=i.replace(/ style="width: 50px;"/g,""),i=i.replace(/"\/>/g,""),i=i.replace(/ /g,""),i.split(`
`).forEach(async u=>{u.indexOf(".")>0&&a.push(u)}),a.length>0&&await l.onFilePathList(a)}else await l.onFilePath(e)},W=e=>new Promise((a,i)=>{const u=new Image;u.crossOrigin="anonymous",u.onload=()=>{const w=document.createElement("canvas"),C=w.getContext("2d");w.width=u.width,w.height=u.height,C.drawImage(u,0,0);try{const $=w.toDataURL("image/png");a($)}catch($){i($)}},u.onerror=()=>{i(new Error("Failed to load image"))},u.src=e});return t.jsx("div",{className:"my-2 mb-[50px], w-full",children:t.jsxs("form",{onSubmit:F(S),style:{width:"100%",minHeight:"300px",maxHeight:{height:k},display:"flex",flexDirection:"column"},children:[t.jsx(fe,{onSubmit:e=>I(),onCancel:l.onCancel,isSubmitting:_.current}),t.jsx(ve,{control:j,onDelete:R,onInsert:B,onRename:A,setContent:Y,onFileUpload:M,imageList:l.imageList}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{className:"w-full",children:t.jsx(D,{name:"edTitle",placeholder:s("title_placeholder"),control:j,className:"w-full",rules:{required:s("required_field"),minLength:{value:2,message:s("min_length_2")}},onChange:e=>{e.preventDefault(),v("edTitle",e.target.value)}})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(xe,{name:"edGbn",label:s("category"),control:j,rules:{required:!0},placeholder:s("category_placeholder"),options:O,className:"",allClassName:"max-w-40",onChange:e=>{e.preventDefault();const a=e.target.value;v("edGbn",a)}}),t.jsx(he,{id:"edDate",name:"edDate",placeholder:s("select_date_placeholder"),control:j,onChange:(e,a)=>{v("edDate",a)}})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(D,{name:"edUrl",placeholder:s("base64_url_placeholder"),control:j,className:"w-full",allClassName:"w-full",onChange:e=>{e.preventDefault();const a=e.target.value;v("edUrl",a),y(a)}}),t.jsx(T,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),H(b("edUrl2"))},children:s("apply")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(D,{name:"edUrl2",placeholder:s("base64_image_data_placeholder"),className:"w-full",allClassName:"w-full",variant:"filled",size:"md",value:b("edUrl2")||""}),t.jsx(T,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),q()},children:s("add_attachment")})]}),t.jsxs("div",{className:"flex gap-2 w-full",children:[t.jsx(D,{name:"edFilePath",placeholder:s("add_to_imagelist_placeholder"),className:"w-full",allClassName:"w-full",control:j,onChange:e=>{e.preventDefault();const a=e.target.value;v("edFilePath",a)}}),t.jsx(T,{size:"sm",variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),J()},children:s("file_path")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(T,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),Z()},children:s("all_files")}),t.jsx(T,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),z()},children:s("all_files_10")})]})]}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{children:t.jsx("div",{className:"max-h-100 overflow-y-scroll",children:t.jsx(Q,{postData:o})})}),t.jsx("div",{children:t.jsx(ge,{ref:c,className:"",value:o,onChange:e=>{v("memoTxt",e),r(e)},rows:20})}),b("edUrl")&&G(b("edUrl"))&&t.jsx("div",{className:"mt-2 p-2 border border-gray-300 dark:border-gray-600 rounded",children:t.jsx("img",{src:n,alt:s("preview"),className:"max-w-full h-auto max-h-48 object-contain",onLoad:async e=>{try{const a=await W(n);v("edUrl2",a)}catch(a){console.error("Base64 conversion failed:",a)}},onError:e=>{e.target.style.display="none"}})})]}),t.jsx(pe,{onClick:V}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"})]})})},be=async(l,d,m,o,r)=>{const s=l==="memo"?`${l}/${d.uid}/`:`${l}/`,n=await ae(s,o.key,r,o.ext);if(n.success){const y=l==="memo"?`memo_txt/${d.uid}/${m}/image/`:`home_txt/${m}/image/`;U(y+o.key,null);const x={...o,key:n.key,url:n.url,name:`${n.key}.${o.ext}`};return U(y+n.key,x),x}},E=async(l,d,m)=>{if(Array.isArray(m)&&m.length>0)for(const o of m)try{await L(l,d,o)}catch(r){console.error(`Error getting path for ${o}:`,r)}else typeof m=="string"&&await L(l,d,m)},Be=({rootDb:l})=>{const{scrollYProgress:d}=we();ye(d,{stiffness:100,damping:30,restDelta:.001});const m=ce(),{user:o}=se(),{memoId:r}=me();de();const s=le(),{memoMap:n,isLoading:y}=ne(l,o,r);console.log("MemoDetailEdit.title=",n?.title);const x=()=>{const c=`/${l==="memo"?"m":l}/${r==="insert"?"":r}`;m(c)},_=(c,f,k)=>{s(ie({rootDb:l,memoId:r,values:c,imageList:f,files:k,user:o})).unwrap().then(g=>{s({type:"tabs/updateTabTitle",payload:{id:g.key,title:g.title}}),s({type:"bookmark/updateBookmarkTitle",payload:{id:g.key,title:g.title}}),s(re({id:g.key,newTitle:g.title}));const N=`/${g.rootDb==="memo"?"m":g.rootDb}/${g.key}`;m(N,{state:{reflash:!0}})})};return h.useEffect(()=>{n&&n.title!==void 0&&oe({title:n.title,description:n.title});function c(){document.querySelectorAll("pre").forEach((f,k)=>{})}n&&n.memo!==null&&c()},[n]),r===""||o===void 0?t.jsx(t.Fragment,{}):n===void 0||y?t.jsx(P,{}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"w-full p-0 m-0",children:n&&(n.title===void 0||n.title===""||n.title===null)?t.jsx(P,{}):t.jsx(je,{onPostSubmit:_,onCancel:x,onRename:(c,f)=>be(l,o,r,c,f),onFilePath:c=>E(o.uid,r,c),onFilePathList:c=>E(o.uid,r,c),title:n?.title,gbn:n?.gbn,date:n?.date,htmlCheck:n?.html?n?.html==="Y"?"Y":"N":"Y",iconCheck:!n?.icon==="Y"?"Y":"N",content:n?.memo,imageList:n?.image})})})};export{Be as MemoDetailUtil,Be as default};

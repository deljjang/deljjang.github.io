import{r as h,e as Q,a3 as W,K as X,j as t,a8 as T,a7 as ee,aH as te,i as k,a1 as ae,bY as se,bZ as le,b_ as U,b$ as ne,t as L,h as oe,k as re,g as ie,a as ce,s as de,a4 as me,V as ue,L as P}from"./index-ChoWCdWa.js";import{T as ge}from"./TwTextArea-BB36DPgE.js";import{T as he,D as xe,H as fe,u as ve}from"./useMemoMutation-CqfyHPfA.js";import{u as pe,a as we,b as je}from"./MemoComm-i9YOQ2sK.js";import"./angle-right-B2--YQzj.js";const ye=s=>{const[d,m]=h.useState(s.imageList),[o,i]=h.useState(s.content),{t:l}=Q(),[g,n]=h.useState(),x=h.useRef(),_=h.useRef(!1),b=h.useRef(null),C=h.useRef([]),{height:c}=W(),w={edTitle:s.title,edGbn:s.gbn?s.gbn:"etc",edDate:s.date,content:s.content,memoTxt:s.content,htmlCheck:"N",iconCheck:"N"},{register:N,handleSubmit:$,trigger:Ce,control:j,setValue:f,getValues:y,watch:Ne,formState:{errors:ke,isSubmitting:De}}=X({mode:"onChange",defaultValues:w});h.useEffect(()=>{N("edDate"),N("memoTxt")},[]),h.useEffect(()=>{C.current=[],x.current=s.content},[s.content]);const S=async e=>{await s.onPostSubmit(e,d,C.current)},R=()=>{$(S)()},B=e=>{m(e)},I=e=>{let a=x.current;e.ext==="jpg"||e.ext==="png"?(a+=`<img src='${e.url}'/>`,v(`<img src='${e.url}'/>
`)):e.ext==="mp4"?(a+=`<video preload="auto" controls="" src='${e.url}'></video>`,v(`<video preload="auto" controls="" src='${e.url}'></video>`)):(a+=`<a src='${e.url}'>${e.name}}</a>`,v(`${l("download_link_text")}
<a href="${e.url}" target="_blank">${e.name}</a>
`)),x.current=a},A=e=>s.onRename(e,y("edTitle")),Y=e=>{x.current=e},M=e=>{C.current=e};function H(e){v(`<img src='${e}'/>`)}function V(){let e="";d&&d.length>0&&d.map((a,r)=>{e+=`<img src="/data/memo/${a.key}.${a.ext}" style="width: 50px;"/>
`}),e!==""&&v(e)}const q=[{value:"none",label:l("none")},{value:"react",label:l("react")},{value:"css",label:l("css")},{value:"android",label:l("android")},{value:"java",label:l("java")},{value:"image",label:l("image")},{value:"etc",label:l("etc")},{value:"mui",label:l("mui")}],v=e=>{const a=b.current;if(a){const r=a.selectionStart,u=a.selectionEnd,p=o.slice(0,r),D=o.slice(u);i(p+e+D),f("memoTxt",p+e+D),setTimeout(()=>{a.selectionStart=a.selectionEnd=r+e.length,a.focus()},100)}},O=e=>{v(e)},G=e=>e?/\.(jpg|jpeg|png|gif|bmp|webp|svg)/i.test(e)||e.includes("image")||e.includes("img"):!1,Z=async()=>{await se("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1")},z=async()=>{const e=await le("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1");let a="";e.map(r=>{a+=r+`
`}),v(a)},J=async()=>{const e=y("edFilePath");if(e===""){const a=[];let r=b.current.value;r=r.replace(/<img src="\/data\/memo\//g,""),r=r.replace(/ style="width: 50px;"/g,""),r=r.replace(/"\/>/g,""),r=r.replace(/ /g,""),r.split(`
`).forEach(async u=>{u.indexOf(".")>0&&a.push(u)}),a.length>0&&await s.onFilePathList(a)}else await s.onFilePath(e)},K=e=>new Promise((a,r)=>{const u=new Image;u.crossOrigin="anonymous",u.onload=()=>{const p=document.createElement("canvas"),D=p.getContext("2d");p.width=u.width,p.height=u.height,D.drawImage(u,0,0);try{const F=p.toDataURL("image/png");a(F)}catch(F){r(F)}},u.onerror=()=>{r(new Error("Failed to load image"))},u.src=e});return t.jsx("div",{className:"my-2 mb-[50px], w-full",children:t.jsxs("form",{onSubmit:$(S),style:{width:"100%",minHeight:"300px",maxHeight:{height:c},display:"flex",flexDirection:"column"},children:[t.jsx(he,{onSubmit:e=>R(),onCancel:s.onCancel,isSubmitting:_.current}),t.jsx(xe,{control:j,onDelete:B,onInsert:I,onRename:A,setContent:Y,onFileUpload:M,imageList:s.imageList}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{className:"w-full",children:t.jsx(T,{name:"edTitle",placeholder:l("title_placeholder"),control:j,className:"w-full",rules:{required:l("required_field"),minLength:{value:2,message:l("min_length_2")}},onChange:e=>{e.preventDefault(),f("edTitle",e.target.value)}})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(ee,{name:"edGbn",label:l("category"),control:j,rules:{required:!0},placeholder:l("category_placeholder"),options:q,className:"",allClassName:"max-w-40",onChange:e=>{e.preventDefault();const a=e.target.value;f("edGbn",a)}}),t.jsx(te,{id:"edDate",name:"edDate",placeholder:l("select_date_placeholder"),control:j,onChange:(e,a)=>{f("edDate",a)}})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(T,{name:"edUrl",placeholder:l("base64_url_placeholder"),control:j,className:"w-full",allClassName:"w-full",onChange:e=>{e.preventDefault();const a=e.target.value;f("edUrl",a),n(a)}}),t.jsx(k,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),H(y("edUrl2"))},children:l("apply")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(T,{name:"edUrl2",placeholder:l("base64_image_data_placeholder"),className:"w-full",allClassName:"w-full",variant:"filled",size:"md",value:y("edUrl2")||""}),t.jsx(k,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),V()},children:l("add_attachment")})]}),t.jsxs("div",{className:"flex gap-2 w-full",children:[t.jsx(T,{name:"edFilePath",placeholder:l("add_to_imagelist_placeholder"),className:"w-full",allClassName:"w-full",control:j,onChange:e=>{e.preventDefault();const a=e.target.value;f("edFilePath",a)}}),t.jsx(k,{size:"sm",variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),J()},children:l("file_path")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(k,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),Z()},children:l("all_files")}),t.jsx(k,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),z()},children:l("all_files_10")})]})]}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{children:t.jsx("div",{className:"max-h-100 overflow-y-scroll",children:t.jsx(ae,{postData:o})})}),t.jsx("div",{children:t.jsx(ge,{ref:b,className:"",value:o,onChange:e=>{f("memoTxt",e),i(e)},rows:20})}),y("edUrl")&&G(y("edUrl"))&&t.jsx("div",{className:"mt-2 p-2 border border-gray-300 dark:border-gray-600 rounded",children:t.jsx("img",{src:g,alt:l("preview"),className:"max-w-full h-auto max-h-48 object-contain",onLoad:async e=>{try{const a=await K(g);f("edUrl2",a)}catch(a){console.error("Base64 conversion failed:",a)}},onError:e=>{e.target.style.display="none"}})})]}),t.jsx(fe,{onClick:O}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"})]})})},be=async(s,d,m,o,i)=>{const l=s==="memo"?`${s}/${d.uid}/`:`${s}/`,g=await ne(l,o.key,i,o.ext);if(g.success){const n=s==="memo"?`memo_txt/${d.uid}/${m}/image/`:`home_txt/${m}/image/`;L(n+o.key,null);const x={...o,key:g.key,url:g.url,name:`${g.key}.${o.ext}`};return L(n+g.key,x),x}},E=async(s,d,m)=>{if(Array.isArray(m)&&m.length>0)for(const o of m)try{await U(s,d,o)}catch(i){console.error(`Error getting path for ${o}:`,i)}else typeof m=="string"&&await U(s,d,m)},Ue=({rootDb:s})=>{const{scrollYProgress:d}=pe();we(d,{stiffness:100,damping:30,restDelta:.001});const m=oe(),{user:o}=re(),{memoId:i}=ie();ce(),de();const l=me(),g=c=>{l(setBookmarkUpdate(c))},{memoDetailData:n,isLoading:x}=je(s,o,i,g);console.log("MemoDetailEdit.title=",n?.title);const _=()=>{const c=`/${s==="memo"?"m":s}/${i==="insert"?"":i}`;m(c)},b=ve(s,i),C=(c,w,N)=>{b.mutate({values:c,imageList:w,files:N})};return h.useEffect(()=>{n&&n.title!==void 0&&ue({title:n.title,description:n.title});function c(){document.querySelectorAll("pre").forEach((w,N)=>{})}n&&n.memo!==null&&c()},[n]),i===""||o===void 0?t.jsx(t.Fragment,{}):n===void 0||x?t.jsx(P,{}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"w-full p-0 m-0",children:n&&(n.title===void 0||n.title===""||n.title===null)?t.jsx(P,{}):t.jsx(ye,{onPostSubmit:C,onCancel:_,onRename:(c,w)=>be(s,o,i,c,w),onFilePath:c=>E(o.uid,i,c),onFilePathList:c=>E(o.uid,i,c),title:n?.title,gbn:n?.gbn,date:n?.date,htmlCheck:n?.html?n?.html==="Y"?"Y":"N":"Y",iconCheck:!n?.icon==="Y"?"Y":"N",content:n?.memo,imageList:n?.image})})})};export{Ue as MemoDetailUtil,Ue as default};

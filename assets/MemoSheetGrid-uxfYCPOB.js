import{i as te,j as t,cU as ae,z as F,bo as B,a9 as G,t as Fe,a6 as Me,o as Re,D as Ie,r as m,k as Ae,cG as $,cM as U,K as y,M as Y,cg as Oe,dy as ee,dz as Ee,m as ze,dA as Be}from"./index-DJthDwo5.js";import{T as Pe}from"./TwToast-D4sojcjt.js";const Qe=({onInsert:I,onDelete:r,onReload:se,onCsvSave:f,onSaveAll:o,onCopy:p,colorPalette:j,textColorPalette:A,handleColorClick:h,handleColorRightClick:O,handleTextColorClick:w,handleTextColorRightClick:E})=>{const{t:N}=te(),b=[p&&{id:"copy",label:N("public"),onClick:p,color:"secondary"},{id:"csv",label:N("csv_save"),onClick:f,color:"sky"},{id:"save",label:N("save"),onClick:o,color:"sky"},{id:"delete",label:N("delete"),onClick:r,color:"warning"},{id:"insert",label:N("insert"),onClick:I,color:"sky"}].filter(Boolean),T={hidden:{opacity:0,y:10},visible:u=>({opacity:1,y:0,transition:{delay:u*.05,type:"spring",stiffness:300,damping:20}}),exit:u=>({opacity:0,y:10,transition:{delay:(b.length-u)*.05,duration:.1}})};return t.jsx(ae,{children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx("div",{className:"flex flex-col items-end space-y-2 p-1 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:[b.slice(0,3),b.slice(3)].map((u,D)=>u.length>0&&t.jsx("div",{className:`${D===0?"flex items-center justify-end space-x-2":`w-full ${F.between}`}`,children:u.map((_,P)=>{const Q=D*3+P;return t.jsx(B.div,{custom:Q,variants:T,initial:"hidden",animate:"visible",exit:"exit",children:t.jsx(G,{size:"sm",color:_.color,onClick:_.onClick,children:_.label})},_.id)})},`group-${D}`))}),t.jsx("div",{children:t.jsx(B.div,{custom:1,variants:T,initial:"hidden",animate:"visible",exit:"exit",className:"p-2 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"flex items-center justify-end space-x-1",children:j.map(u=>t.jsx("div",{onClick:()=>h(u),onContextMenu:D=>O(D,u),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white",style:{backgroundColor:u}},`bg-${u}`))}),t.jsx("div",{className:"flex items-center justify-end space-x-1",children:A.map((u,D)=>t.jsx("div",{onClick:()=>w(u),onContextMenu:_=>E(_,u),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white flex items-center justify-center text-sm font-bold",style:{backgroundColor:"#fff",color:u},children:D%2===0?"A":"a"},`text-${u}`))})]})},"color-palettes")})]})})},Le=({detailData:I})=>{const{user:r}=Fe(),{ui:se}=Me(),{t:f}=te(),{sheetId:o}=Re(),p=Ie(),[j,A]=m.useState([]),h=m.useRef(null),O=m.useRef(null),w=m.useRef(null),[E,N]=m.useState([]),[b,T]=m.useState(void 0),[u,D]=m.useState(void 0),[_,P]=m.useState(""),[Q,J]=m.useState({isOpen:!1}),[oe,S]=m.useState({show:!1,message:""}),[q,H]=m.useState(""),[L,ne]=m.useState(!1),[re,K]=m.useState(!1),[z,V]=m.useState(""),ie=["#FFADAD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF"],le=["#000000","#D00000","#AE4600","#006400","#00529B","#0018A8","#5A00A8","#A800A8"],ce=e=>{if(!h.current?.hotInstance||!w.current)return;const{row:a,col:i,row2:n,col2:d}=w.current,l=Math.min(a,n),c=Math.max(a,n),k=Math.min(i,d),v=Math.max(i,d),x=[...b];let R=!1;for(let g=l;g<=c;g++){x[g]||(x[g]=Array(j.length).fill(""));for(let C=k;C<=v;C++)x[g][C]!==e&&(x[g][C]=e,R=!0)}R&&T(x)},de=(e,s)=>{e.preventDefault();const a=h.current?.hotInstance;if(!a)return;const i=a.countRows(),n=[...b];let d=!1;for(let l=0;l<i;l++)if(n[l])for(let c=0;c<n[l].length;c++)n[l][c]===s&&(n[l][c]=void 0,d=!0);d&&T(n)},ue=e=>{if(!h.current?.hotInstance||!w.current)return;const{row:a,col:i,row2:n,col2:d}=w.current,l=Math.min(a,n),c=Math.max(a,n),k=Math.min(i,d),v=Math.max(i,d),x=[...u];let R=!1;for(let g=l;g<=c;g++){x[g]||(x[g]=Array(j.length).fill(void 0));for(let C=k;C<=v;C++)x[g][C]!==e&&(x[g][C]=e,R=!0)}R&&D(x)},me=(e,s)=>{e.preventDefault();const a=h.current?.hotInstance;if(!a)return;const i=a.countRows(),n=[...u];let d=!1;for(let l=0;l<i;l++)if(n[l])for(let c=0;c<n[l].length;c++)n[l][c]===s&&(n[l][c]=void 0,d=!0);d&&D(n)},{data:M,isLoading:he}=Ae({queryKey:["sheetData",o,r?.uid],queryFn:async()=>{if(!o||!r)return{rowData:[],colorData:[],colorTextData:[]};const e=`memo_sheet_data/${r?.uid}/${o}/data`,s=`memo_sheet_data/${r?.uid}/${o}/color`,a=`memo_sheet_data/${r?.uid}/${o}/textColor`,[i,n,d]=await Promise.all([$(e),$(s),$(a)]),l=i?Object.values(i).map(v=>typeof v=="string"?JSON.parse(v):v):[],c=n?Object.values(n).map(v=>JSON.parse(v)):[],k=d?Object.values(d).map(v=>JSON.parse(v)):[];return{rowData:l,colorData:c,colorTextData:k}},enabled:!!o&&!!r&&j.length>0,staleTime:1e3*60*5});m.useEffect(()=>{M&&(N(M.rowData),T(M.colorData),D(M.colorTextData))},[M]);function fe(){const e=I?.scrollY?I.scrollY:0;window.scrollTo({top:e})}m.useEffect(()=>{o&&r&&($(`memo_sheet/${r?.uid}/${o}/columns`).then(e=>{A(e||[{title:"title",data:"title",type:"text"}])}),$(`memo_sheet_data/${r?.uid}/${o}/memo`).then(e=>{H(e||"")}),fe())},[o,r]);const xe=async()=>{h.current.hotInstance.getPlugin("exportFile").downloadFile("csv",{filename:`sheet_${o}`,mimeType:"text/csv",bom:!1,columnDelimiter:",",rowDelimiter:`\r
`})};async function we(){const e=h.current?.hotInstance;if(!e)return;let s;if(w.current&&w.current.row>=0){const a=w.current.row;s=a+1,e.alter("insert_row_below",a,1)}else s=0,e.alter("insert_row_above",0,1);e.selectCell(s,0)}const{mutate:ge}=U({mutationFn:async({rowsDB:e,bgColorDataToSave:s,textColorDataToSave:a})=>{await De(e,s,a)},onMutate:async({rowsDB:e,bgColorDataToSave:s,textColorDataToSave:a})=>{await p.cancelQueries({queryKey:["sheetData",o,r?.uid]});const i=p.getQueryData(["sheetData",o,r?.uid]),n=e.map(c=>JSON.parse(c)),d=s.map(c=>JSON.parse(c)),l=a.map(c=>JSON.parse(c));return p.setQueryData(["sheetData",o,r?.uid],c=>({...c,rowData:n,colorData:d,colorTextData:l})),{previousSheetData:i}},onError:(e,s,a)=>{a?.previousSheetData&&p.setQueryData(["sheetData",o,r?.uid],a.previousSheetData)},onSuccess:()=>{S({show:!0,message:f("save_completed")}),setTimeout(()=>S({show:!1,message:""}),2e3)},onSettled:()=>{p.invalidateQueries({queryKey:["sheetData",o,r?.uid]})}}),pe=async()=>{y(`memo_sheet_data/${r?.uid}/${o}/memo`,z),H(z),K(!1)},ve=()=>{V(q),K(!0)},De=(e,s,a)=>{y(`memo_sheet_data/${r?.uid}/${o}/data`,null),e.map((i,n)=>{y(`memo_sheet_data/${r?.uid}/${o}/data/${n}`,i)}),y(`memo_sheet_data/${r?.uid}/${o}/color`,s),y(`memo_sheet_data/${r?.uid}/${o}/textColor`,a),y(`memo_sheet/${r?.uid}/${o}/createdAt`,Date.now()),y(`memo_sheet/${r?.uid}/${o}/count`,e.length)},ye=U({mutationFn:async()=>{if(!r||!o)throw new Error("User or Sheet ID is missing.");const e=`memo_sheet/${r.uid}/${o}`,s=`memo_sheet_data/${r.uid}/${o}`,[a,i]=await Promise.all([$(e),$(s)]);if(console.log("sheetMeta=",a),console.log("sheetData=",i),!a)throw new Error("Sheet metadata not found.");const n=await $(`home_txt/${o}`);console.log("data=",n);const d={title:n?.title||a.title,color:i?.color||[],columns:a.columns||[],createdAt:a.createdAt||Date.now(),data:i?.data||[],gbn:n?.gbn||"etc",html:"sheet",memo:n?.memo||i?.memo||"",textColor:i?.textColor||[]};await y(`${e}/public`,"Y"),await y(`home_txt/${o}`,d),await y(`home_txt/${o}`,d)},onSuccess:()=>{Ce(f("copy_completed"))},onError:e=>{console.error("Copy failed:",e);const s=`${f("copy_failed")} ${e.message?`: ${e.message}`:""}`;S({show:!0,message:s}),setTimeout(()=>S({show:!1,message:""}),3e3)}}),be=()=>{ye.mutate()},Ce=e=>{S({show:!0,message:e}),setTimeout(()=>S({show:!1,message:""}),2e3)},W=async(e=!0)=>{const s=h.current?.hotInstance;if(!s)return;const a=s.getSourceData(),i=[];a.forEach((l,c)=>{l.id=c;const k=[];j.forEach((v,x)=>{k.push(l[x]?l[x]:"")}),i.push(JSON.stringify(k))});const n=b.map(l=>JSON.stringify(l||[])),d=u.map(l=>JSON.stringify(l||[]));console.log("rowData=",i),console.log("bgColorDataToSave=",n),console.log("textColorDataToSave=",d),ge({rowsDB:i,bgColorDataToSave:n,textColorDataToSave:d})},je=(e,s,a,i)=>{w.current={row:e,col:s,row2:a,col2:i}},_e=async(e,s,a)=>{W(!1);const i=h.current?.hotInstance;if(!i)return;const n=j.map((d,l)=>({...d,width:i.getColWidth(l)}));A(n),y(`memo_sheet/${r?.uid}/${o}/columns`,n)},{mutate:Se}=U({mutationFn:async e=>e,onMutate:async e=>{await p.cancelQueries({queryKey:["sheetData",o,r?.uid]});const s=p.getQueryData(["sheetData",o,r?.uid]);return p.setQueryData(["sheetData",o,r?.uid],a=>{const i=[...a.rowData];return i.splice(e,1),{...a,rowData:i}}),h.current?.hotInstance.alter("remove_row",e,1),w.current=null,{previousSheetData:s}},onError:(e,s,a)=>{p.setQueryData(["sheetData",o,r?.uid],a.previousSheetData)},onSettled:()=>{}}),ke=()=>{J({isOpen:!1})},$e=()=>{h.current.hotInstance;const e=w.current.row;console.log("onDelete=",e),J({isOpen:!1}),Se(e)},Ne=async()=>{if(w.current&&h.current?.hotInstance){const e=f("delete_confirm_title"),s=f("delete_confirm_message_simple");J({isOpen:!0,title:e,message:s,color:"warning"})}else S({show:!0,message:f("select_row_to_delete")}),setTimeout(()=>{S({show:!1,message:""})},2e3)};if(r===void 0)return t.jsx("div",{className:"flex flex-col items-center justify-center h-full w-full mt-50",children:t.jsx(Y,{children:f("login_required")})});const X=()=>{const e=O.current.value;P(e);const s=h.current?.hotInstance;s&&s.render()},Te=e=>{e.key==="Enter"&&(e.preventDefault(),X())},Z=()=>t.jsxs("div",{className:"pt-5",children:[t.jsx("div",{className:"mb-4 h-14 bg-gray-200 dark:bg-zinc-800 rounded-md animate-shimmer relative overflow-hidden"}),t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 pb-2 items-end",children:t.jsx("div",{className:"h-10 bg-gray-200 dark:bg-zinc-900 rounded-md animate-shimmer relative overflow-hidden"})}),t.jsxs("div",{className:"mt-2 space-y-1",children:[t.jsx("div",{className:"h-10 bg-gray-200 dark:bg-zinc-900 rounded-t-md animate-shimmer relative overflow-hidden"}),[...Array(5)].map((e,s)=>t.jsx("div",{className:"h-8 bg-gray-300 dark:bg-zinc-800 rounded animate-shimmer relative overflow-hidden"},s))]})]});return he?t.jsx(Z,{}):E===void 0||b===void 0||u===void 0?t.jsx(Z,{}):t.jsxs("div",{className:"pt-5 relative",children:[t.jsx(Pe,{...oe}),t.jsx(Oe,{...Q,onConfirm:$e,onClose:ke}),t.jsx("div",{className:"mb-4",children:re?t.jsxs("div",{className:`${F.card} p-4`,children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx(Y,{children:f("input")}),t.jsx("textarea",{className:"w-full h-64 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500",value:z,onChange:e=>V(e.target.value),autoFocus:!0})]}),t.jsxs("div",{children:[t.jsx(Y,{children:f("preview")}),t.jsx("div",{className:"prose dark:prose-invert max-w-none p-2 border rounded h-64 overflow-y-auto dark:bg-gray-700 dark:border-gray-600",children:t.jsx(ee,{children:z})})]})]}),t.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[t.jsx(G,{variant:"outlined",color:F.button.indigo,size:"sm",onClick:()=>K(!1),children:f("cancel")}),t.jsx(G,{color:F.button.indigo,onClick:pe,children:f("save")})]})]}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"relative",children:t.jsxs("div",{className:`${F.card} p-4 min-h-[4rem] cursor-pointer prose dark:prose-invert max-w-none`,onDoubleClick:ve,children:[q?t.jsx(ee,{children:q}):t.jsx("p",{className:"text-gray-400",children:f("double_click_to_edit_memo")}),t.jsx("button",{onClick:()=>ne(!L),className:`${F.floatingActionButton} absolute bottom-4 right-2`,children:t.jsx(B.div,{animate:{rotate:L?45:0},children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})})})]})})})}),t.jsxs("div",{className:"flex items-center justify-between pb-2",children:[t.jsx(Ee,{inputRef:O,onKeyDown:Te,onSearch:X}),t.jsx(ae,{children:L&&t.jsx(B.div,{className:"absolute mb-5 buttom-0 right-0 z-180 flex flex-col items-end",initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},transition:{duration:.2,ease:"easeInOut"},children:t.jsx(Qe,{onInsert:we,onDelete:Ne,colorPalette:ie,textColorPalette:le,handleColorClick:ce,handleColorRightClick:de,handleTextColorClick:ue,handleTextColorRightClick:me,onCsvSave:xe,onSaveAll:W,onCopy:r?.uid===ze?be:null})},"fab-menu")})]}),t.jsx("div",{className:"relative",children:t.jsx(Be,{hotRef:h,search:_,columns:j,rowData:E,colorData:b,colorTextData:u,afterSelection:je,handleAfterColumnResize:_e})})]})};export{Le as MemoSheetGrid,Le as default};

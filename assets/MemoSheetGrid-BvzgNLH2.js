import{h as X,j as t,a4 as S,q as Te,a2 as W,n as ke,z as Fe,r as u,Q as Me,i as Ie,cc as _,ep as Q,I as D,J,bU as Re,x as R,eW as Ae,m as ze}from"./index-CkNAgZXs.js";import{a as Ee}from"./MemoDetailGrid-DFbI0_a5.js";import{A}from"./AniButton-Bk_GH33z.js";import{T as Oe}from"./TwToast-Cc_iYg4I.js";import{M as H}from"./HtmlCode-z2y3bH0b.js";import"./Button-CAdZBARH.js";import"./copy-CVBf9aWA.js";import"./ComponentCard-BLx4kEF4.js";import"./TwRadio-DvxalnTw.js";import"./TwBadge-D75AVI19.js";import"./HtmlCode-Bgd8C8O9.js";import"./toPropertyKey-DCwh5dYN.js";const Be=({ui:F,onInsert:r,onDelete:M,onReload:m,onCsvSave:a,onSaveAll:v,onCopy:y})=>{const{t:p}=X();return F==="tailwind"?t.jsxs("div",{className:"my-2 flex justify-end items-center",children:[y!==null&&t.jsx(S,{size:"sm",variant:"outlined",color:"brand",className:"mr-2",onClick:y,children:p("copy")}),t.jsx(S,{size:"sm",variant:"outlined",color:"brand",className:"mr-2",onClick:v,children:p("save")}),t.jsx(S,{size:"sm",variant:"outlined",color:"brand",className:"mr-2",onClick:r,children:p("insert")}),t.jsx(S,{size:"sm",variant:"outlined",color:"warning",className:"mr-1",onClick:M,children:p("delete")}),t.jsx(S,{size:"sm",variant:"outlined",color:"brand",className:"ml-1",onClick:a,children:p("csv_save")})]}):t.jsxs("div",{className:"my-2 flex justify-end items-center gap-1",children:[t.jsx(A,{type:"button",size:"small",variant:"outlined",color:"warning",className:"mr-2",onClick:r,children:p("insert")}),t.jsx(A,{type:"button",size:"small",variant:"outlined",color:"error",className:"mr-2",onClick:M,children:p("delete")}),t.jsx(A,{type:"button",size:"small",variant:"outlined",color:"success",className:"mr-2",onClick:m,children:p("reload")}),t.jsx(A,{type:"button",size:"small",variant:"outlined",color:"success",onClick:a,children:p("csv_save")})]})},at=({detailData:F})=>{const{user:r}=Te(),{ui:M}=W(),{t:m}=X(),{sheetId:a}=ke(),v=Fe(),[y,p]=u.useState([]),f=u.useRef(null),q=u.useRef(null),x=u.useRef(null),[K,Z]=u.useState([]),[N,z]=u.useState(void 0),[$,E]=u.useState(void 0),[ee,te]=u.useState(""),[se,O]=u.useState({isOpen:!1}),[oe,j]=u.useState({show:!1,message:""}),[B,L]=u.useState(""),[ae,P]=u.useState(!1),[I,U]=u.useState(""),re=["#FFADAD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF"],ne=["#000000","#D00000","#AE4600","#006400","#00529B","#0018A8","#5A00A8","#A800A8"],le=e=>{if(!f.current?.hotInstance||!x.current)return;const{row:o,col:n,row2:l,col2:d}=x.current,i=Math.min(o,l),c=Math.max(o,l),b=Math.min(n,d),w=Math.max(n,d),h=[...N];let k=!1;for(let g=i;g<=c;g++){h[g]||(h[g]=Array(y.length).fill(""));for(let C=b;C<=w;C++)h[g][C]!==e&&(h[g][C]=e,k=!0)}k&&z(h)},ie=(e,s)=>{e.preventDefault();const o=f.current?.hotInstance;if(!o)return;const n=o.countRows(),l=[...N];let d=!1;for(let i=0;i<n;i++)if(l[i])for(let c=0;c<l[i].length;c++)l[i][c]===s&&(l[i][c]=void 0,d=!0);d&&z(l)},ce=e=>{if(!f.current?.hotInstance||!x.current)return;const{row:o,col:n,row2:l,col2:d}=x.current,i=Math.min(o,l),c=Math.max(o,l),b=Math.min(n,d),w=Math.max(n,d),h=[...$];let k=!1;for(let g=i;g<=c;g++){h[g]||(h[g]=Array(y.length).fill(void 0));for(let C=b;C<=w;C++)h[g][C]!==e&&(h[g][C]=e,k=!0)}k&&E(h)},de=(e,s)=>{e.preventDefault();const o=f.current?.hotInstance;if(!o)return;const n=o.countRows(),l=[...$];let d=!1;for(let i=0;i<n;i++)if(l[i])for(let c=0;c<l[i].length;c++)l[i][c]===s&&(l[i][c]=void 0,d=!0);d&&E(l)},{theme:Pe}=W(),{register:ue,reset:Qe,control:Je,setValue:qe,getValues:Ke,formState:{errors:Le}}=Me({mode:"submit "}),{data:T,isLoading:me}=Ie({queryKey:["sheetData",a,r?.uid],queryFn:async()=>{if(!a||!r)return{rowData:[],colorData:[],colorTextData:[]};const e=`memo_sheet_data/${r?.uid}/${a}/data`,s=`memo_sheet_data/${r?.uid}/${a}/color`,o=`memo_sheet_data/${r?.uid}/${a}/textColor`,[n,l,d]=await Promise.all([_(e),_(s),_(o)]),i=n?Object.values(n).map(w=>typeof w=="string"?JSON.parse(w):w):[],c=l?Object.values(l).map(w=>JSON.parse(w)):[],b=d?Object.values(d).map(w=>JSON.parse(w)):[];return{rowData:i,colorData:c,colorTextData:b}},enabled:!!a&&!!r&&y.length>0,staleTime:1e3*60*5});u.useEffect(()=>{T&&(Z(T.rowData),z(T.colorData),E(T.colorTextData))},[T]);function he(){const e=F?.scrollY?F.scrollY:0;window.scrollTo({top:e})}u.useEffect(()=>{a&&r&&(_(`memo_sheet/${r?.uid}/${a}/columns`).then(e=>{p(e||[{title:"title",data:"title",type:"text"}]),ue("filterField1")}),_(`memo_sheet_data/${r?.uid}/${a}/memo`).then(e=>{L(e||"")}),he())},[a,r]);const fe=async()=>{f.current.hotInstance.getPlugin("exportFile").downloadFile("csv",{filename:`sheet_${a}`,mimeType:"text/csv",bom:!1,columnDelimiter:",",rowDelimiter:`\r
`})};async function ge(){const e=f.current?.hotInstance;if(!e)return;let s;x.current&&x.current.row>=0?(s=x.current.row+1,e.alter("insert_row_below",x.current.row,1)):(s=0,e.alter("insert_row_above",0,1)),e.selectCell(s,0)}const{mutate:pe}=Q({mutationFn:async({rowsDB:e,bgColorDataToSave:s,textColorDataToSave:o})=>{await ve(e,s,o)},onMutate:async({rowsDB:e,bgColorDataToSave:s,textColorDataToSave:o})=>{await v.cancelQueries({queryKey:["sheetData",a,r?.uid]});const n=v.getQueryData(["sheetData",a,r?.uid]),l=e.map(c=>JSON.parse(c)),d=s.map(c=>JSON.parse(c)),i=o.map(c=>JSON.parse(c));return v.setQueryData(["sheetData",a,r?.uid],c=>({...c,rowData:l,colorData:d,colorTextData:i})),{previousSheetData:n}},onError:(e,s,o)=>{o?.previousSheetData&&v.setQueryData(["sheetData",a,r?.uid],o.previousSheetData)},onSuccess:()=>{j({show:!0,message:m("save_completed")}),setTimeout(()=>j({show:!1,message:""}),2e3)},onSettled:()=>{v.invalidateQueries({queryKey:["sheetData",a,r?.uid]})}}),xe=async()=>{D(`memo_sheet_data/${r?.uid}/${a}/memo`,I),L(I),P(!1)},we=()=>{U(B),P(!0)},ve=(e,s,o)=>{D(`memo_sheet_data/${r?.uid}/${a}/data`,null),e.map((n,l)=>{D(`memo_sheet_data/${r?.uid}/${a}/data/${l}`,n)}),D(`memo_sheet_data/${r?.uid}/${a}/color`,s),D(`memo_sheet_data/${r?.uid}/${a}/textColor`,o),D(`memo_sheet/${r?.uid}/${a}/createdAt`,Date.now()),D(`memo_sheet/${r?.uid}/${a}/count`,e.length)},De=Q({mutationFn:async()=>{if(!r||!a)throw new Error("User or Sheet ID is missing.");const e=`memo_sheet/${r.uid}/${a}`,s=`memo_sheet_data/${r.uid}/${a}`,[o,n]=await Promise.all([_(e),_(s)]);if(console.log("sheetMeta=",o),console.log("sheetData=",n),!o)throw new Error("Sheet metadata not found.");const l=await _(`home_txt/${a}`);console.log("data=",l);const d={title:l?.title||o.title,color:n?.color||[],columns:o.columns||[],createdAt:o.createdAt||Date.now(),data:n?.data||[],gbn:l?.gbn||"etc",html:"sheet",memo:l?.memo||n?.memo||"",textColor:n?.textColor||[]};await D(`${e}/public`,"Y"),await D(`home_txt/${a}`,d),await D(`home_txt/${a}`,d)},onSuccess:()=>{j({show:!0,message:m("copy_completed")}),setTimeout(()=>j({show:!1,message:""}),2e3)},onError:e=>{console.error("Copy failed:",e);const s=`${m("copy_failed")} ${e.message?`: ${e.message}`:""}`;j({show:!0,message:s}),setTimeout(()=>j({show:!1,message:""}),3e3)}}),ye=()=>{De.mutate()},V=async(e=!0)=>{const s=f.current?.hotInstance;if(!s)return;const o=s.getSourceData(),n=[];o.forEach((i,c)=>{i.id=c;const b=[];y.forEach((w,h)=>{b.push(i[h]?i[h]:"")}),n.push(JSON.stringify(b))}),console.log("rowsDB=",n);const l=N.map(i=>JSON.stringify(i||[])),d=$.map(i=>JSON.stringify(i||[]));console.log("rowData=",n),console.log("bgColorDataToSave=",l),console.log("textColorDataToSave=",d),pe({rowsDB:n,bgColorDataToSave:l,textColorDataToSave:d})},Ce=(e,s,o,n)=>{x.current={row:e,col:s,row2:o,col2:n}},je=async(e,s,o)=>{V(!1);const n=f.current?.hotInstance;if(!n)return;const l=y.map((d,i)=>({...d,width:n.getColWidth(i)}));p(l),D(`memo_sheet/${r?.uid}/${a}/columns`,l)},{mutate:be}=Q({mutationFn:async e=>e,onMutate:async e=>{await v.cancelQueries({queryKey:["sheetData",a,r?.uid]});const s=v.getQueryData(["sheetData",a,r?.uid]);return v.setQueryData(["sheetData",a,r?.uid],o=>{const n=[...o.rowData];return n.splice(e,1),{...o,rowData:n}}),f.current?.hotInstance.alter("remove_row",e,1),x.current=null,{previousSheetData:s}},onError:(e,s,o)=>{v.setQueryData(["sheetData",a,r?.uid],o.previousSheetData)},onSettled:()=>{}}),_e=()=>{O({isOpen:!1})},Se=()=>{f.current.hotInstance;const e=x.current.row;console.log("onDelete=",e),O({isOpen:!1}),be(e)},Ne=async()=>{if(x.current&&f.current?.hotInstance){const e=m("delete_confirm_title"),s=m("delete_confirm_message_simple");O({isOpen:!0,title:e,message:s,color:"warning"})}else j({show:!0,message:m("select_row_to_delete")}),setTimeout(()=>{j({show:!1,message:""})},2e3)};if(r===void 0)return t.jsx("div",{className:"flex flex-col items-center justify-center h-full w-full mt-50",children:t.jsx(J,{children:m("login_required")})});const Y=()=>{const e=q.current.value;te(e);const s=f.current?.hotInstance;s&&s.render()},$e=e=>{e.key==="Enter"&&(e.preventDefault(),Y())},G=()=>t.jsxs("div",{className:"pt-5",children:[t.jsx("div",{className:"mb-4 h-14 bg-gray-200 dark:bg-zinc-800 rounded-md animate-shimmer relative overflow-hidden"}),t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 pb-2 items-end",children:t.jsx("div",{className:"h-10 bg-gray-200 dark:bg-zinc-900 rounded-md animate-shimmer relative overflow-hidden"})}),t.jsxs("div",{className:"mt-2 space-y-1",children:[t.jsx("div",{className:"h-10 bg-gray-200 dark:bg-zinc-900 rounded-t-md animate-shimmer relative overflow-hidden"}),[...Array(5)].map((e,s)=>t.jsx("div",{className:"h-8 bg-gray-300 dark:bg-zinc-800 rounded animate-shimmer relative overflow-hidden"},s))]})]});return me?t.jsx(G,{}):K===void 0||N===void 0||$===void 0?t.jsx(G,{}):t.jsxs("div",{className:"pt-5 relative",children:[t.jsx(Oe,{...oe}),t.jsx(Re,{...se,onConfirm:Se,onClose:_e}),t.jsx("div",{className:"mb-4",children:ae?t.jsxs("div",{className:`${R.card} p-4`,children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx(J,{children:m("input")}),t.jsx("textarea",{className:"w-full h-64 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500",value:I,onChange:e=>U(e.target.value),autoFocus:!0})]}),t.jsxs("div",{children:[t.jsx(J,{children:m("preview")}),t.jsx("div",{className:"prose dark:prose-invert max-w-none p-2 border rounded h-64 overflow-y-auto dark:bg-gray-700 dark:border-gray-600",children:t.jsx(H,{children:I})})]})]}),t.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[t.jsx(S,{variant:"outlined",color:R.button.indigo,size:"sm",onClick:()=>P(!1),children:m("cancel")}),t.jsx(S,{color:R.button.indigo,onClick:xe,children:m("save")})]})]}):t.jsx("div",{className:`${R.card} p-4 min-h-[4rem] cursor-pointer prose dark:prose-invert max-w-none`,onDoubleClick:we,children:B?t.jsx(H,{children:B}):t.jsx("p",{className:"text-gray-400",children:m("double_click_to_edit_memo")})})}),t.jsxs("div",{className:"group",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 pb-2 items-end",children:[t.jsx("div",{className:"TwInputSearch",children:t.jsx(Ae,{inputRef:q,onKeyDown:$e,onSearch:Y})}),t.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-300",children:t.jsxs("div",{className:"flex flex-col items-end",children:[t.jsx(Be,{ui:M,onInsert:ge,onDelete:Ne,onCsvSave:fe,onSaveAll:V,onCopy:r?.uid===ze?ye:null}),t.jsxs("div",{className:"flex items-center justify-end mt-1",children:[re.map(e=>t.jsx("div",{onClick:()=>le(e),onContextMenu:s=>ie(s,e),className:"w-5 h-5 cursor-pointer border border-gray-400",style:{backgroundColor:e}},`bg-${e}`)),ne.map((e,s)=>t.jsx("div",{onClick:()=>ce(e),onContextMenu:o=>de(o,e),className:"w-5 h-5 cursor-pointer border border-gray-400 flex items-center justify-center text-xs font-bold",style:{backgroundColor:"#fff",color:e},children:s%2===0?"ê°€":"A"},`text-${e}`))]})]})})]}),t.jsx(Ee,{hotRef:f,search:ee,columns:y,rowData:K,colorData:N,colorTextData:$,afterSelection:Ce,handleAfterColumnResize:je})]})]})};export{at as MemoSheetGrid,at as default};

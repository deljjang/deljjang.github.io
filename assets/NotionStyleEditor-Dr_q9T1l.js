import{q as Z,a0 as ue,h as K,n as me,r as s,j as e,I as xe,e3 as ee,bf as A,y as C,k as pe,O as fe,e4 as he,J,a2 as V,cc as ge,G as be,c4 as W,c5 as Q,ca as ye,c9 as ve,c6 as we}from"./index-CjFOdZ7J.js";import{T as je,u as ke,a as Ne,D as Se,c as Ce,P as De,B as Y,b as Le,v as Re,S as _e,d as $e}from"./SortableBlock-BVKHG8zW.js";import{M as Te}from"./HtmlCode-454GHr9J.js";const He=({rootDb:g,detailData:i})=>{console.log("MemoDetailGrid.detailData=",g,i);const{user:b}=Z(),{ui:u}=ue(),{t:k}=K(),{sheetId:r}=me(),[o,y]=s.useState([]),m=s.useRef(null);s.useRef(null);const[f,N]=s.useState([]),[c,v]=s.useState(void 0),[h,x]=s.useState(void 0),[p,_]=s.useState(""),[d,j]=s.useState({show:!1,message:""}),[D,I]=s.useState(""),[M,z]=s.useState(!0);if(s.useEffect(()=>{if(i){z(!0);const{columns:E,data:R,color:S,textColor:H,memo:F}=i;y(E||[{title:"title",data:"title",type:"text"}]),I(F||"");const O=R?Object.values(R).map(L=>typeof L=="string"?JSON.parse(L):L):[],U=S?Object.values(S).map(L=>JSON.parse(L)):[],P=H?Object.values(H).map(L=>JSON.parse(L)):[];N(O),v(U),x(P),z(!1)}},[i]),b===void 0)return e.jsx("div",{className:"flex flex-col items-center justify-center h-full w-full mt-50",children:e.jsx(xe,{children:k("login_required")})});const T=()=>e.jsxs("div",{className:"pt-5",children:[e.jsx("div",{className:"mb-4 h-14 bg-gray-200 dark:bg-zinc-800 rounded-md animate-shimmer relative overflow-hidden"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 pb-2 items-end",children:e.jsx("div",{className:"h-10 bg-gray-200 dark:bg-zinc-900 rounded-md animate-shimmer relative overflow-hidden"})}),e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsx("div",{className:"h-10 bg-gray-200 dark:bg-zinc-900 rounded-t-md animate-shimmer relative overflow-hidden"}),[...Array(5)].map((E,R)=>e.jsx("div",{className:"h-8 bg-gray-300 dark:bg-zinc-800 rounded animate-shimmer relative overflow-hidden"},R))]})]});return M?e.jsx(T,{}):f===void 0||c===void 0||h===void 0?e.jsx(T,{}):e.jsxs("div",{className:"relative",children:[e.jsx(ee,{children:d.show&&e.jsx(A.div,{initial:{y:"-100%",opacity:0},animate:{y:0,opacity:1},exit:{y:"-100%",opacity:0},transition:{duration:.3,ease:"easeInOut"},className:"fixed top-50 left-1/2 -translate-x-1/2 z-[2000] p-3 rounded-lg shadow-lg bg-green-500 text-white font-semibold",children:d.message})}),e.jsx("div",{className:"mb-4",children:e.jsx("div",{className:`${C.card} p-4 min-h-[4rem] prose dark:prose-invert max-w-none`,children:D?e.jsx(Te,{children:D}):e.jsx("p",{className:"text-gray-400",children:k("double_click_to_edit_memo")})})}),e.jsx("div",{className:"group",children:e.jsx(je,{hotRef:m,search:p,columns:o,rowData:f,colorData:c,colorTextData:h})})]})},te=s.forwardRef(({size:g="md",color:i="default",name:b,placeholder:u,value:k,onChange:r,className:o="",allClassName:y="",min:m,max:f,step:N,disabled:c=!1,control:v,rules:h=null,defaultValue:x="",onKeyDownCapture:p,error:_,helperText:d,...j},D)=>{const M=v?._formState?.errors?.[b]?"error":i,z=H=>{r&&r(H)},T={sm:`h-9 px-3 py-2 ${C.textSm}`,md:`h-11 px-4 py-2.5 ${C.textSm}`,lg:"h-12 px-4 py-3 text-base"},E={default:"bg-transparent text-gray-800 border-gray-300 focus:border-brand-300 focus:ring-brand-500/20 dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800",success:"border-green-500 focus:border-green-300 focus:ring-green-500/20 dark:text-green-400 dark:border-green-500 dark:focus:border-green-800",error:"border-red-500 focus:border-red-300 focus:ring-red-500/20 dark:text-red-400 dark:border-red-500 dark:focus:border-red-800"},R="text-gray-500 border-gray-300 bg-gray-100 cursor-not-allowed opacity-60 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700",S=`w-full ${C.roundedLg} border appearance-none shadow-theme-xs placeholder:text-gray-400 focus:outline-none focus:ring-3 dark:bg-zinc-950 dark:placeholder:text-white/30`;return e.jsxs("div",{className:`relative ${y}`,children:[e.jsx("input",{type:"text",name:b,placeholder:u,ref:D,onChange:z,min:m,max:f,step:N,disabled:c,onKeyDownCapture:p,className:`
          ${S}
          ${T[g]}
          ${c?R:E[M]}
          ${o}
        `,...j}),d&&e.jsx("p",{className:`mt-1 ${C.textSm} text-red-600 dark:text-red-400`,children:d})]})});te.displayName="TwInputRef";const ne=pe.forwardRef(({title:g,children:i,className:b="",desc:u="",icon:k=null,isDraggable:r=!1},o)=>{const y=s.useRef(null),[m,f]=s.useState({x:0,y:0,isInitialized:!1}),[N,c]=s.useState(!1),v=s.useRef({x:0,y:0});s.useEffect(()=>{if(r&&y.current&&!m.isInitialized){const d=y.current.getBoundingClientRect(),j=window.innerWidth/2-672/2<=0?0:window.innerWidth/2-672/2;f({x:j,y:window.innerHeight/2-d.height/2,isInitialized:!0})}},[r,m.isInitialized]);const h=d=>{if(!r||!y.current)return;c(!0);const j=y.current.getBoundingClientRect();v.current={x:d.clientX-j.left,y:d.clientY-j.top},d.preventDefault()},x=d=>{if(!N)return;const j=d.clientX-v.current.x<=0?0:d.clientX-v.current.x,D=d.clientY-v.current.y<=120?120:d.clientY-v.current.y;f({...m,x:j,y:D})},p=()=>{c(!1)};s.useEffect(()=>(N?(window.addEventListener("mousemove",x),window.addEventListener("mouseup",p)):(window.removeEventListener("mousemove",x),window.removeEventListener("mouseup",p)),()=>{window.removeEventListener("mousemove",x),window.removeEventListener("mouseup",p)}),[N]);const _=r?{position:"absolute",top:m.y,left:m.x,cursor:N?"grabbing":"default"}:{};return e.jsxs("div",{ref:d=>{y.current=d,o&&(o.current=d)},className:`MoveCard ${C.card} ${b}`,style:{..._},children:[e.jsxs("div",{className:`flex px-6 py-5 items-center ${r?"cursor-grab":""}`,onMouseDown:h,children:[k!==null?k:"",e.jsxs("div",{className:"flex-grow",children:[e.jsx("h3",{className:`${C.textBase} ${C.fontMedium} text-gray-800 dark:text-white/90`,children:g}),u&&e.jsx("p",{className:`mt-1 ${C.textSm} text-gray-500 dark:text-gray-400`,children:u})]})]}),e.jsx("div",{className:`border-t border-gray-100 dark:border-gray-800 
        p-4 sm:p-6 overflow-x-auto`,children:e.jsx("div",{className:"space-y-6 whitespace-normal",children:i})})]})});ne.displayName="MoveCard";const ae=s.forwardRef(({name:g,options:i,rules:b,control:u,placeholder:k="Select Option",className:r="",allClassName:o="",...y},m)=>e.jsxs("div",{className:`relative ${o}`,children:[e.jsxs("select",{className:`h-11 w-full appearance-none ${C.roundedLg} border border-gray-300 
          bg-transparent px-4 py-2.5 pr-11 text-sm shadow-theme-xs placeholder:text-gray-400 
          focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 
          dark:border-gray-700 dark:bg-zinc-950 dark:text-white/90 dark:placeholder:text-white/30 
          dark:focus:border-brand-800 dark:bg-dark-900
          ${r}`,ref:m,...y,children:[e.jsx("option",{value:"",disabled:!0,className:"text-gray-700 dark:bg-zinc-950 dark:text-gray-400",children:k}),i.map(f=>e.jsx("option",{value:f.value,className:"text-gray-700 dark:bg-zinc-950 dark:text-gray-400",children:f.label},f.value))]}),e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 h-11",children:e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]}));ae.displayName="TwSelectRef";const Ee=({isOpen:g,onClose:i,onCreate:b})=>{const u={visible:{opacity:1},hidden:{opacity:0}},k={hidden:{y:"-50px",opacity:0,scale:.95},visible:{y:"0",opacity:1,scale:1,transition:{duration:.2,ease:"easeOut"}},exit:{y:"50px",opacity:0,scale:.95,transition:{duration:.15,ease:"easeIn"}}},{t:r}=K(),{control:o,handleSubmit:y}=fe({defaultValues:{columns:[{title:"col_0",type:"text",width:100,data:"col_0"},{title:"col_1",type:"text",width:100,data:"col_1"},{title:"col_2",type:"text",width:100,data:"col_2"}]}}),{fields:m,append:f,remove:N}=he({control:o,name:"columns"}),c=[{value:"text",label:r("column_type_text")},{value:"numeric",label:r("column_type_numeric")},{value:"date",label:r("column_type_date")},{value:"checkbox",label:r("column_type_checkbox")}],v=h=>{const x=h.columns.map((p,_)=>({...p,data:(p.title||"").toLowerCase().replace(/\s+/g,"_")||`col_${_}`}));b(x)};return e.jsx(ee,{children:g&&e.jsx(A.div,{className:"fixed inset-0 bg-black/70 bg-opacity-50 z-180 flex justify-center items-center",variants:u,initial:"hidden",animate:"visible",exit:"hidden",children:e.jsx(A.div,{variants:k,initial:"hidden",animate:"visible",exit:"exit",onClick:h=>h.stopPropagation(),children:e.jsx(ne,{isDraggable:!0,className:"w-full max-w-sm sm:max-w-xl max-h-[61vh] overflow-y-auto",title:r("handsontable_column_setup","Handsontable Column Setup"),children:e.jsxs("form",{onSubmit:y(v),children:[e.jsx("h3",{className:"text-md font-semibold mb-2",children:r("columns")}),e.jsx("div",{className:"space-y-3",children:m.map((h,x)=>e.jsxs("div",{className:`grid grid-cols-1 sm:grid-cols-5 gap-2 items-center p-2 ${C.border} rounded-md`,children:[e.jsx("div",{className:"sm:col-span-2",children:e.jsx(J,{name:`columns.${x}.title`,control:o,defaultValue:h.title,render:({field:p})=>e.jsx(te,{...p,placeholder:r("column_title")})})}),e.jsx("div",{className:"sm:col-span-2",children:e.jsx(J,{name:`columns.${x}.type`,control:o,defaultValue:h.type,render:({field:p})=>e.jsx(ae,{...p,options:c,className:"dark:bg-gray-700"})})}),e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(V,{type:"button",size:"sm",color:"warning",onClick:()=>N(x),disabled:m.length<=1,children:r("delete")})})]},h.id))}),e.jsxs("div",{className:"flex justify-between items-center mt-6",children:[e.jsx(V,{type:"button",onClick:()=>f({title:"",type:"text",data:""}),children:r("add_column")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(V,{type:"button",variant:"outlined",onClick:i,children:r("cancel")}),e.jsx(V,{type:"submit",children:r("create")})]})]})]})})})})})},Be=({id:g,children:i,onDragEnd:b})=>{const u=ke(Ne(De,{activationConstraint:{distance:8}}));return e.jsx(Se,{id:g,sensors:u,collisionDetection:Ce,onDragEnd:b,children:i})},Oe=({rootDb:g,memoId:i,readOnly:b=!1})=>{const{user:u}=Z(),{t:k}=K(),[r,o]=s.useState([]),[y,m]=s.useState(""),[f,N]=s.useState("p"),c=s.useRef(null),v=s.useRef(null),[h,x]=s.useState(!1),[p,_]=s.useState(""),[d,j]=s.useState(!1),[D,I]=s.useState(0),M=s.useRef(!0),[z,T]=s.useState(!0),E=g==="memo"?`${g}_txt/${u?.uid}/${i}/notion`:`${g}_txt/${i}/notion`;s.useEffect(()=>{(g==="home"||u)&&i&&(T(!0),ge(E).then(t=>{t&&o(t),T(!1),M.current=!1}))},[u,i]),s.useEffect(()=>{!M.current&&u&&i&&be(E,r)},[r,u,i]);const R=[{command:"p",label:"Paragraph"},{command:"h1",label:"Heading 1"},{command:"h2",label:"Heading 2"},{command:"todo",label:"To-do list"},{command:"quote",label:"Quote"},{command:"code",label:"Code Block"},{command:"link",label:"Link"},{command:"image",label:"Image"},{command:"divider",label:"Divider"},{command:"handsontable",label:"Handsontable"},{command:"table",label:"Table"},{command:"youtube",label:"YouTube Video"}],S=p?R.filter(t=>t.label.toLowerCase().includes(p.toLowerCase())):R,H=t=>{if(h){t.key==="ArrowDown"?(t.preventDefault(),I(n=>(n+1)%S.length)):t.key==="ArrowUp"?(t.preventDefault(),I(n=>(n-1+S.length)%S.length)):t.key==="Enter"?(t.preventDefault(),S[D]&&q(S[D].command)):t.key==="Escape"&&(t.preventDefault(),x(!1));return}if(t.key==="Enter"&&!t.shiftKey){t.preventDefault();const n=c.current?.innerHTML||"";if(n.trim()==="/"){c.current&&(c.current.innerHTML=""),x(!1);return}if(c.current?.textContent.trim()===""&&!n.includes("<img"))return;const a={id:Date.now(),content:y,style:f,...f==="todo"&&{checked:!1}};o([...r,a]),m(""),c.current&&(c.current.innerHTML="")}},F=t=>{const n=t.currentTarget.textContent;n.startsWith("/")?(x(!0),_(n.substring(1)),I(0)):x(!1),m(t.currentTarget.innerHTML)},O=(t,n)=>{o(a=>a.map(l=>l.id===t?{...l,content:n}:l))},U=(t,n)=>{o(a=>a.map(l=>l.id===t?{...l,style:n}:l))},P=(t,n)=>{o(a=>a.map(l=>l.id===t?{...l,...n}:l))},L=t=>{const n=r.find(a=>a.id===t);if(n&&n.style==="image"&&n.content)try{const a=W(Q,n.content);ye(a).catch(l=>{console.error("Error deleting image from storage:",l)})}catch(a){console.error("Error creating storage reference from URL:",a)}o(a=>a.filter(l=>l.id!==t))},X=t=>{o(n=>{const a=n.findIndex(B=>B.id===t);if(a===-1)return n;const w={...n[a],id:Date.now()},$=[...n];return $.splice(a+1,0,w),$})},se=t=>{const{active:n,over:a}=t;console.log("active=",n),console.log("over=",a),n.id!==a.id&&o(l=>{const w=l.findIndex(B=>B.id===n.id),$=l.findIndex(B=>B.id===a.id);return $e(l,w,$)})},re=t=>{const n={id:Date.now(),content:"",style:"p"};o(a=>{const l=a.findIndex($=>$.id===t);if(l===-1)return[...a,n];const w=[...a];return w.splice(l,0,n),w})},oe=t=>{const n=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/,a=t.match(n);return a&&a[2].length===11?a[2]:null},q=t=>{if(t==="image")v.current?.click();else if(t==="divider"){const n={id:Date.now(),style:"divider",content:""};o(a=>[...a,n])}else if(t==="handsontable")j(!0);else if(t==="code"){const n={id:Date.now(),style:"code",language:"javascript",content:""};o(a=>[...a,n])}else if(t==="table"){const n={id:Date.now(),style:"table",content:{rows:[[{text:""},{text:""}],[{text:""},{text:""}]]}};o(a=>[...a,n])}else if(t==="youtube"){const n=prompt("Enter YouTube URL:");if(n){const a=oe(n);if(a){const l={id:Date.now(),style:"youtube",content:a};o(w=>[...w,l])}else alert("Invalid YouTube URL")}}else if(t==="link"){const n=prompt("Enter URL:");if(n){const a=prompt("Enter link text (optional):",n),l={id:Date.now(),style:"link",content:n,text:a||n};o(w=>[...w,l])}}else N(t),c.current?.focus();c.current&&(c.current.innerHTML=""),m(""),x(!1),_("")},le=t=>{const n={id:Date.now(),style:"handsontable",content:{data:[Array(t.length).fill("")],columns:t,colHeaders:t.map(a=>a.title),rowHeaders:!0,height:"auto",licenseKey:"non-commercial-and-evaluation"}};o(a=>[...a,n]),j(!1)},ie=async t=>{const n=t.target.files[0];if(!n||!u||!i)return;const a=`memo_txt_images/${u.uid}/${i}/${Date.now()}_${n.name}`,l=W(Q,a);try{const w=await ve(l,n),$=await we(w.ref),B={id:Date.now(),content:$,style:"image"};o(de=>[...de,B])}catch(w){console.error("Image upload failed:",w)}},ce=k("notion_input_placeholder","Type '/' for commands, or just start writing..."),G={p:"text-base",h1:"text-3xl font-bold my-4",h2:"text-2xl font-bold my-3",code:"font-mono bg-gray-100 dark:bg-zinc-700 p-4 rounded-md text-sm",todo:"flex items-center gap-2 my-1",link:"text-blue-600 dark:text-blue-400 hover:underline",quote:"border-l-4 border-gray-300 dark:border-zinc-600 pl-4 italic text-base my-2",image:"my-4",divider:"my-4",handsontable:"my-4",youtube:"my-4",table:"my-4 w-full"};return e.jsxs("div",{className:`NotionStyleEditor ${C.card} mt-1 py-4 border-gray-200 dark:border-zinc-700`,children:[e.jsx(Be,{onDragEnd:se,blocks:r,styleClasses:G,onUpdateBlock:P,onUpdate:O,onStyleChange:U,onDelete:L,onDuplicate:X,readOnly:b,children:z?e.jsxs("div",{className:"mb-4 space-y-4 p-2",children:[e.jsx(Y,{type:"h1"}),e.jsx(Y,{type:"p"}),e.jsx(Y,{type:"code"}),e.jsx(Y,{type:"image"})]}):e.jsx(Le,{items:r,strategy:Re,children:e.jsx("div",{className:"SortableBlockList mb-4 space-y-2",children:r.map(t=>e.jsx(_e,{id:t.id,block:t,styleClasses:G,onUpdateBlock:P,onUpdate:O,onStyleChange:U,onDelete:L,onDuplicate:X,onInsertBlock:re,readOnly:b},t.id))})})}),e.jsxs("div",{className:"relative",children:[h&&e.jsx(A.div,{className:"absolute bottom-full mb-2 w-full sm:w-64 bg-white z-180 dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 rounded-lg shadow-xl",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.1},children:e.jsxs("div",{className:"p-2",children:[e.jsx("p",{className:"text-xs text-gray-500 px-2 pb-1 font-semibold",children:"BLOCKS"}),S.length>0?S.map((t,n)=>e.jsx("button",{onClick:()=>q(t.command),className:`w-full text-left px-2 py-1.5 rounded text-sm ${n===D?"bg-gray-100 dark:bg-zinc-700":""} hover:bg-gray-100 dark:hover:bg-zinc-700`,children:t.label},t.command)):e.jsx("p",{className:"px-2 py-1.5 text-sm text-gray-500",children:"No results"})]})}),!b&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",ref:v,onChange:ie,accept:"image/*",className:"hidden"}),e.jsx("div",{ref:c,contentEditable:"true",onInput:F,onKeyDown:H,"data-placeholder":ce,className:`notion-selectable w-full bg-transparent focus:outline-none text-gray-800 dark:text-gray-200 
						min-h-[2.5rem] p-2 border border-transparent focus:border-blue-500 rounded-md
						empty:before:content-[attr(data-placeholder)] empty:before:text-gray-400 empty:before:dark:text-gray-500 empty:before:cursor-text`})]})]}),e.jsx(Ee,{isOpen:d,onClose:()=>j(!1),onCreate:le})]})};export{Be as D,He as M,Oe as N,te as T,ne as a,ae as b};

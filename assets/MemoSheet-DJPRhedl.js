import{i as E,V as K,du as R,j as e,cT as V,bo as A,dv as U,dw as M,z as Q,N as I,dx as H,a9 as b,r as T,p as B,D as W,u as Y,t as G,k as J,cL as D,by as X,bz as Z,E as F,G as P,K as j,M as ee,bF as te,cf as se,bx as ae}from"./index-CEJkszmk.js";import{T as ie}from"./TwToast-BNMv6fVA.js";const re=({isOpen:r,onClose:u,onCreate:w})=>{const x={visible:{opacity:1},hidden:{opacity:0}},_={hidden:{y:"-50px",opacity:0,scale:.95},visible:{y:"0",opacity:1,scale:1,transition:{duration:.2,ease:"easeOut"}},exit:{y:"50px",opacity:0,scale:.95,transition:{duration:.15,ease:"easeIn"}}},{t:a}=E(),{register:k,control:m,handleSubmit:d,formState:{errors:g}}=K({defaultValues:{title:"",columns:[{title:"col_0",type:"text",width:100,data:"col_0"},{title:"col_1",type:"text",width:100,data:"col_1"},{title:"col_2",type:"text",width:100,data:"col_2"}]}}),{fields:s,append:S,remove:N}=R({control:m,name:"columns"}),C=[{value:"text",label:a("column_type_text")},{value:"numeric",label:a("column_type_numeric")},{value:"date",label:a("column_type_date")},{value:"checkbox",label:a("column_type_checkbox")}],l=o=>{if(!o.title||o.title.trim()===""){alert(a("sheet_title_required"));return}const y={...o,columns:o.columns.map((c,$)=>c.data&&(c.data==="id"||c.data==="title"||c.data==="description")?c:{...c,data:(c.title||"").toLowerCase().replace(/\s+/g,"_")||`col_${$}`})};w(y)};return e.jsx(V,{children:r&&e.jsx(A.div,{className:"fixed inset-0 bg-black/70 bg-opacity-50 z-180 flex justify-center items-center",variants:x,initial:"hidden",animate:"visible",exit:"hidden",children:e.jsx(A.div,{variants:_,initial:"hidden",animate:"visible",exit:"exit",onClick:o=>o.stopPropagation(),children:e.jsx(U,{isDraggable:!0,className:"w-full max-w-sm sm:max-w-xl max-h-[61vh] overflow-y-auto",title:a("create_new_sheet"),children:e.jsxs("form",{onSubmit:d(l),children:[e.jsx("div",{className:"mb-4",children:e.jsx(M,{...k("title",{required:a("sheet_title_required")}),label:a("sheet_title"),placeholder:a("sheet_title_placeholder"),error:!!g.title,helperText:g.title?.message})}),e.jsx("h3",{className:"text-md font-semibold mb-2",children:a("columns")}),e.jsx("div",{className:"space-y-3",children:s.map((o,y)=>e.jsxs("div",{className:`grid grid-cols-1 sm:grid-cols-5 gap-2 items-center p-2 ${Q.border} rounded-md`,children:[e.jsx("div",{className:"sm:col-span-2",children:e.jsx(I,{name:`columns.${y}.title`,control:m,defaultValue:o.title,render:({field:c})=>e.jsx(M,{...c,placeholder:a("column_title")})})}),e.jsx("div",{className:"sm:col-span-2",children:e.jsx(I,{name:`columns.${y}.type`,control:m,defaultValue:o.type,render:({field:c})=>e.jsx(H,{...c,options:C,className:"dark:bg-gray-700"})})}),e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(b,{type:"button",size:"sm",color:"warning",onClick:()=>N(y),disabled:s.length<=1,children:a("delete")})})]},o.id))}),e.jsxs("div",{className:"flex justify-between items-center mt-6",children:[e.jsx(b,{type:"button",onClick:()=>S({title:"",type:"text",data:""}),children:a("add_column")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{type:"button",variant:"outlined",onClick:u,children:a("cancel")}),e.jsx(b,{type:"submit",children:a("create")})]})]})]})})})})})},ne={isEditing:!1,editingTitle:""};function le(r,u){switch(console.log("state",r),console.log("action",u),u.type){case"START_EDIT":return{isEditing:!0,editingTitle:u.payload.initialTitle};case"CANCEL_EDIT":return{isEditing:!1,editingTitle:""};case"UPDATE_TITLE":return{...r,editingTitle:u.payload};case"FINISH_EDIT":return{...r,isEditing:!1};default:throw new Error(`Unhandled action type: ${u.type}`)}}const oe=({sheet:r,onCardClick:u,onUpdateTitle:w,onShowToast:x,onDeleteClick:_})=>{const{t:a}=E(),[k,m]=T.useReducer(le,ne),{isEditing:d,editingTitle:g}=k,s=l=>{l.stopPropagation(),m({type:"START_EDIT",payload:{initialTitle:r.title}})},S=l=>{l.stopPropagation(),m({type:"CANCEL_EDIT"})},N=l=>{if(l.stopPropagation(),!g.trim()){x(a("sheet_title_required"),"red");return}w(r.id,g),m({type:"FINISH_EDIT"})},C=l=>{if(!l)return"";const o=new Date(l);return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")} ${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}`};return e.jsx("div",{onClick:()=>!d&&u(r.id),className:"SheetCard relative flex flex-col justify-between p-4 bg-white dark:bg-zinc-900 rounded-lg shadow-lg hover:shadow-xl dark:hover:shadow-lg dark:hover:shadow-gray-800 hover:-translate-y-1 transition-all duration-300 cursor-pointer group",children:d?e.jsxs("div",{className:"SheetCard_editflex flex-col gap-2",children:[e.jsx("input",{type:"text",value:g,onChange:l=>m({type:"UPDATE_TITLE",payload:l.target.value}),onClick:l=>l.stopPropagation(),className:"border p-2 rounded-md dark:bg-gray-700",autoFocus:!0}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(b,{size:"sm",variant:"outlined",onClick:S,children:a("cancel")}),e.jsx(b,{size:"sm",onClick:N,children:a("save")})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("h6",{className:"text-lg font-bold text-gray-800 dark:text-gray-100 truncate mb-2",children:r.title}),e.jsxs("div",{className:"absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:s,className:"p-1.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"})})}),e.jsx("button",{onClick:l=>{l.stopPropagation(),_(r.id)},className:"p-1.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4 text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r.public==="Y"&&e.jsx("span",{className:"font-semibold px-2 py-0.5 rounded-full bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200",children:a("public")}),e.jsx("span",{children:C(r.createdAt)})]}),e.jsxs("span",{children:[a("count"),": ",r.count||0]})]})]})})};function ue(){const{t:r}=E(),u=B(),[w,x]=T.useState({isOpen:!1}),[_,a]=T.useState(!1),[k,m]=T.useState({show:!1,message:"",color:"red"}),d=W(),{isExpanded:g}=Y(),{user:s}=G(),S=(t=!0)=>s?new Promise(i=>{const n=F(P,`memo_sheet/${s.uid}`);ae(n,f=>{const h=f.val(),v=h?Object.keys(h).map(p=>({id:p,...h[p]})):[];v.sort((p,O)=>(O.createdAt||0)-(p.createdAt||0)),i(v)},{onlyOnce:!0})}):Promise.resolve([]),{data:N,isLoading:C}=J({queryKey:["sheets",s?.uid],queryFn:()=>S(),enabled:!!s}),l=D({mutationFn:async t=>{const i=`memo_sheet/${s.uid}`,n=X(Z(F(P),i)).key,f={title:t.title,columns:t.columns,createdAt:Date.now()};await j(`${i}/${n}`,f);const h=`memo_sheet_data/${s.uid}/${n}/data`,v={id:0,createdAt:Date.now()};return t.columns.forEach(p=>{p.data!=="id"&&p.data!=="createdAt"&&(v[p.data]="")}),await j(`${h}/0`,v),v.id=1,await j(`${h}/1`,v),n},onSuccess:t=>{d.invalidateQueries({queryKey:["sheets",s?.uid]}),a(!1),u(`/m/sheet/${t}`)}}),o=D({mutationFn:t=>{const i=j(`memo_sheet/${s.uid}/${t}`,null),n=j(`memo_sheet_data/${s.uid}/${t}`,null);return Promise.all([i,n]).then(()=>t)},onMutate:async t=>{await d.cancelQueries({queryKey:["sheets",s?.uid]});const i=d.getQueryData(["sheets",s?.uid]);return d.setQueryData(["sheets",s?.uid],n=>n?.filter(f=>f.id!==t)),{previousSheets:i}},onError:(t,i,n)=>{d.setQueryData(["sheets",s?.uid],n.previousSheets)},onSettled:t=>{d.invalidateQueries({queryKey:["sheets",s?.uid]}),d.invalidateQueries({queryKey:["sheetData",t]})}}),y=D({mutationFn:({sheetId:t,title:i})=>j(`memo_sheet/${s.uid}/${t}/title`,i),onMutate:async({sheetId:t,title:i})=>{await d.cancelQueries({queryKey:["sheets",s?.uid]});const n=d.getQueryData(["sheets",s?.uid]);return d.setQueryData(["sheets",s?.uid],f=>f?.map(h=>h.id===t?{...h,title:i}:h)),{previousSheets:n}},onError:(t,i,n)=>{d.setQueryData(["sheets",s?.uid],n.previousSheets)},onSettled:()=>{d.invalidateQueries({queryKey:["sheets",s?.uid]})}}),c=t=>{u(`/m/sheet/${t}`)},$=async(t,i)=>{x({isOpen:!0,title:r("delete_confirm_title"),message:r("delete_confirm_message"),color:"warning",onConfirm:()=>{o.mutate(t),x({isOpen:!1})},onClose:()=>x({isOpen:!1})})},L=g?"grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3":"grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5",q=()=>e.jsx("div",{className:`grid ${L} gap-4`,children:Array.from({length:g?6:8}).map((t,i)=>e.jsxs("div",{className:"flex flex-col justify-between p-4 bg-white dark:bg-zinc-900 rounded-lg shadow-md",children:[e.jsx("div",{className:"flex-grow animate-pulse",children:e.jsx("div",{className:"h-6 bg-gray-200 dark:bg-zinc-800 rounded w-3/4 mb-2"})}),e.jsxs("div",{className:"flex justify-between items-center mt-4 animate-pulse",children:[e.jsx("div",{className:"flex items-center gap-2 w-full",children:e.jsx("div",{className:"h-4 bg-gray-200 dark:bg-zinc-800 rounded w-1/2"})}),e.jsx("div",{className:"h-4 bg-gray-200 dark:bg-zinc-800 rounded w-1/4"})]})]},i))});if(C||s===void 0)return e.jsx(q,{});const z=e.jsxs("div",{className:`${Q.between}`,children:[e.jsx(ee,{className:"text-md",children:r("memo_sheet_list")}),e.jsx(b,{variant:"ghost",color:"sky",onClick:()=>a(!0),children:r("create_new_sheet")})]});return e.jsxs(e.Fragment,{children:[e.jsx(ie,{...k}),e.jsxs(te,{title:z,className:"MemoSheet my-5",children:[e.jsx(se,{...w}),e.jsx(re,{isOpen:_,onClose:()=>a(!1),onCreate:t=>l.mutate(t)}),e.jsx("div",{className:`grid ${L} gap-4`,children:N?.map(t=>e.jsx(oe,{sheet:t,onCardClick:c,onUpdateTitle:(i,n)=>y.mutate({sheetId:i,title:n}),onShowToast:(i,n)=>{m({show:!0,message:i,color:n}),setTimeout(()=>m({show:!1,message:""}),3e3)},onDeleteClick:i=>$(i)},t.id))})]})]})}export{ue as default};

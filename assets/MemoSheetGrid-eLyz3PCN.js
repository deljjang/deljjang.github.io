import{j as t,bk as U,l as O,e as te,p as M,i as H,k as Te,g as Fe,s as Ne,r as h,f as Me,ba as T,bg as Y,t as y,O as G,bK as Ie,aK as Re,bL as ee,bG as Ae,m as Oe,bM as Ee}from"./index-DRYhf1EU.js";const Be=({show:N,message:n,color:m="green"})=>{const a=`bg-${m}-500`;return t.jsx(U,{children:N&&t.jsx(O.div,{initial:{y:"-100%",opacity:0},animate:{y:0,opacity:1},exit:{y:"-100%",opacity:0},transition:{duration:.3,ease:"easeInOut"},className:`fixed top-50 left-1/2 -translate-x-1/2 z-[2000] p-3 rounded-lg shadow-lg ${a} text-white font-semibold`,children:n})})},Pe=({onInsert:N,onDelete:n,onReload:m,onCsvSave:a,onSaveAll:v,onCopy:b,colorPalette:E,textColorPalette:f,handleColorClick:B,handleColorRightClick:w,handleTextColorClick:P,handleTextColorRightClick:J})=>{const{t:D}=te(),F=[b&&{id:"copy",label:D("public"),onClick:b,color:"secondary"},{id:"csv",label:D("csv_save"),onClick:a,color:"sky"},{id:"save",label:D("save"),onClick:v,color:"sky"},{id:"delete",label:D("delete"),onClick:n,color:"warning"},{id:"insert",label:D("insert"),onClick:N,color:"sky"}].filter(Boolean),_={hidden:{opacity:0,y:10},visible:u=>({opacity:1,y:0,transition:{delay:u*.05,type:"spring",stiffness:300,damping:20}}),exit:u=>({opacity:0,y:10,transition:{delay:(F.length-u)*.05,duration:.1}})};return t.jsx(U,{children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx("div",{className:"flex flex-col items-end space-y-2 p-1 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:[F.slice(0,3),F.slice(3)].map((u,C)=>u.length>0&&t.jsx("div",{className:`${C===0?"flex items-center justify-end space-x-2":`w-full ${M.between}`}`,children:u.map((S,z)=>{const I=C*3+z;return t.jsx(O.div,{custom:I,variants:_,initial:"hidden",animate:"visible",exit:"exit",children:t.jsx(H,{size:"sm",color:S.color,onClick:S.onClick,children:S.label})},S.id)})},`group-${C}`))}),t.jsx("div",{children:t.jsx(O.div,{custom:1,variants:_,initial:"hidden",animate:"visible",exit:"exit",className:"p-2 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-lg shadow-lg",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"flex items-center justify-end space-x-1",children:E.map(u=>t.jsx("div",{onClick:()=>B(u),onContextMenu:C=>w(C,u),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white",style:{backgroundColor:u}},`bg-${u}`))}),t.jsx("div",{className:"flex items-center justify-end space-x-1",children:f.map((u,C)=>t.jsx("div",{onClick:()=>P(u),onContextMenu:S=>J(S,u),className:"w-6 h-6 rounded-full cursor-pointer border-2 border-white/50 shadow-md transition-transform hover:scale-110 hover:border-white flex items-center justify-center text-sm font-bold",style:{backgroundColor:"#fff",color:u},children:C%2===0?"A":"a"},`text-${u}`))})]})},"color-palettes")})]})})},Je=({detailData:N})=>{const{user:n}=Te(),{t:m}=te(),{sheetId:a}=Fe(),v=Ne(),[b,E]=h.useState([]),f=h.useRef(null),B=h.useRef(null),w=h.useRef(null),[P,J]=h.useState([]),[D,F]=h.useState(void 0),[_,u]=h.useState(void 0),[C,S]=h.useState(""),[z,I]=h.useState({isOpen:!1}),[oe,$]=h.useState({show:!1,message:""}),[L,V]=h.useState(""),[q,ae]=h.useState(!1),[se,K]=h.useState(!1),[Q,W]=h.useState(""),ne=["#FFADAD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF"],re=["#000000","#D00000","#AE4600","#006400","#00529B","#0018A8","#5A00A8","#A800A8"],le=e=>{if(!f.current?.hotInstance||!w.current)return;const{row:o,col:l,row2:r,col2:d}=w.current,i=Math.min(o,r),c=Math.max(o,r),k=Math.min(l,d),g=Math.max(l,d),x=[...D];let A=!1;for(let p=i;p<=c;p++){x[p]||(x[p]=Array(b.length).fill(""));for(let j=k;j<=g;j++)x[p][j]!==e&&(x[p][j]=e,A=!0)}A&&F(x)},ie=(e,s)=>{e.preventDefault();const o=f.current?.hotInstance;if(!o)return;const l=o.countRows(),r=[...D];let d=!1;for(let i=0;i<l;i++)if(r[i])for(let c=0;c<r[i].length;c++)r[i][c]===s&&(r[i][c]=void 0,d=!0);d&&F(r)},ce=e=>{if(!f.current?.hotInstance||!w.current)return;const{row:o,col:l,row2:r,col2:d}=w.current,i=Math.min(o,r),c=Math.max(o,r),k=Math.min(l,d),g=Math.max(l,d),x=[..._];let A=!1;for(let p=i;p<=c;p++){x[p]||(x[p]=Array(b.length).fill(void 0));for(let j=k;j<=g;j++)x[p][j]!==e&&(x[p][j]=e,A=!0)}A&&u(x)},de=(e,s)=>{e.preventDefault();const o=f.current?.hotInstance;if(!o)return;const l=o.countRows(),r=[..._];let d=!1;for(let i=0;i<l;i++)if(r[i])for(let c=0;c<r[i].length;c++)r[i][c]===s&&(r[i][c]=void 0,d=!0);d&&u(r)},{data:R,isLoading:ue}=Me({queryKey:["sheetData",a,n?.uid],queryFn:async()=>{if(!a||!n)return{rowData:[],colorData:[],colorTextData:[]};const e=`memo_sheet_data/${n?.uid}/${a}/data`,s=`memo_sheet_data/${n?.uid}/${a}/color`,o=`memo_sheet_data/${n?.uid}/${a}/textColor`,[l,r,d]=await Promise.all([T(e),T(s),T(o)]),i=l?Object.values(l).map(g=>typeof g=="string"?JSON.parse(g):g):[],c=r?Object.values(r).map(g=>JSON.parse(g)):[],k=d?Object.values(d).map(g=>JSON.parse(g)):[];return{rowData:i,colorData:c,colorTextData:k}},enabled:!!a&&!!n&&b.length>0,staleTime:1e3*60*5});h.useEffect(()=>{R&&(J(R.rowData),F(R.colorData),u(R.colorTextData))},[R]);function he(){const e=N?.scrollY?N.scrollY:0;window.scrollTo({top:e})}h.useEffect(()=>{a&&n&&(T(`memo_sheet/${n?.uid}/${a}/columns`).then(e=>{E(e||[{title:"title",data:"title",type:"text"}])}),T(`memo_sheet_data/${n?.uid}/${a}/memo`).then(e=>{V(e||"")}),he())},[a,n]);const me=async()=>{f.current.hotInstance.getPlugin("exportFile").downloadFile("csv",{filename:`sheet_${a}`,mimeType:"text/csv",bom:!1,columnDelimiter:",",rowDelimiter:`\r
`})};async function fe(){const e=f.current?.hotInstance;if(!e)return;let s;if(w.current&&w.current.row>=0){const o=w.current.row;s=o+1,e.alter("insert_row_below",o,1)}else s=0,e.alter("insert_row_above",0,1);e.selectCell(s,0)}const{mutate:xe}=Y({mutationFn:async({rowsDB:e,bgColorDataToSave:s,textColorDataToSave:o})=>{await ge(e,s,o)},onMutate:async({rowsDB:e,bgColorDataToSave:s,textColorDataToSave:o})=>{await v.cancelQueries({queryKey:["sheetData",a,n?.uid]});const l=v.getQueryData(["sheetData",a,n?.uid]),r=e.map(c=>JSON.parse(c)),d=s.map(c=>JSON.parse(c)),i=o.map(c=>JSON.parse(c));return v.setQueryData(["sheetData",a,n?.uid],c=>({...c,rowData:r,colorData:d,colorTextData:i})),{previousSheetData:l}},onError:(e,s,o)=>{o?.previousSheetData&&v.setQueryData(["sheetData",a,n?.uid],o.previousSheetData)},onSuccess:()=>{$({show:!0,message:m("save_completed")}),setTimeout(()=>$({show:!1,message:""}),2e3)},onSettled:()=>{v.invalidateQueries({queryKey:["sheetData",a,n?.uid]})}}),we=async()=>{y(`memo_sheet_data/${n?.uid}/${a}/memo`,Q),V(Q),K(!1)},pe=()=>{W(L),K(!0)},ge=(e,s,o)=>{y(`memo_sheet_data/${n?.uid}/${a}/data`,null),e.map((l,r)=>{y(`memo_sheet_data/${n?.uid}/${a}/data/${r}`,l)}),y(`memo_sheet_data/${n?.uid}/${a}/color`,s),y(`memo_sheet_data/${n?.uid}/${a}/textColor`,o),y(`memo_sheet/${n?.uid}/${a}/createdAt`,Date.now()),y(`memo_sheet/${n?.uid}/${a}/count`,e.length)},ve=Y({mutationFn:async()=>{if(!n||!a)throw new Error("User or Sheet ID is missing.");const e=`memo_sheet/${n.uid}/${a}`,s=`memo_sheet_data/${n.uid}/${a}`,[o,l]=await Promise.all([T(e),T(s)]);if(console.log("sheetMeta=",o),console.log("sheetData=",l),!o)throw new Error("Sheet metadata not found.");const r=await T(`home_txt/${a}`);console.log("data=",r);const d={title:r?.title||o.title,color:l?.color||[],columns:o.columns||[],createdAt:o.createdAt||Date.now(),data:l?.data||[],gbn:r?.gbn||"etc",html:"sheet",memo:r?.memo||l?.memo||"",textColor:l?.textColor||[]};await y(`${e}/public`,"Y"),await y(`home_txt/${a}`,d),await y(`home_txt/${a}`,d)},onSuccess:()=>{ye(m("copy_completed"))},onError:e=>{console.error("Copy failed:",e);const s=`${m("copy_failed")} ${e.message?`: ${e.message}`:""}`;$({show:!0,message:s}),setTimeout(()=>$({show:!1,message:""}),3e3)}}),De=()=>{ve.mutate()},ye=e=>{$({show:!0,message:e}),setTimeout(()=>$({show:!1,message:""}),2e3)},X=async(e=!0)=>{const s=f.current?.hotInstance;if(!s)return;const o=s.getSourceData(),l=[];o.forEach((i,c)=>{i.id=c;const k=[];b.forEach((g,x)=>{k.push(i[x]?i[x]:"")}),l.push(JSON.stringify(k))});const r=D.map(i=>JSON.stringify(i||[])),d=_.map(i=>JSON.stringify(i||[]));console.log("rowData=",l),console.log("bgColorDataToSave=",r),console.log("textColorDataToSave=",d),xe({rowsDB:l,bgColorDataToSave:r,textColorDataToSave:d})},be=(e,s,o,l)=>{w.current={row:e,col:s,row2:o,col2:l}},Ce=async(e,s,o)=>{X(!1);const l=f.current?.hotInstance;if(!l)return;const r=b.map((d,i)=>({...d,width:l.getColWidth(i)}));E(r),y(`memo_sheet/${n?.uid}/${a}/columns`,r)},{mutate:je}=Y({mutationFn:async e=>e,onMutate:async e=>{await v.cancelQueries({queryKey:["sheetData",a,n?.uid]});const s=v.getQueryData(["sheetData",a,n?.uid]);return v.setQueryData(["sheetData",a,n?.uid],o=>{const l=[...o.rowData];return l.splice(e,1),{...o,rowData:l}}),f.current?.hotInstance.alter("remove_row",e,1),w.current=null,{previousSheetData:s}},onError:(e,s,o)=>{v.setQueryData(["sheetData",a,n?.uid],o.previousSheetData)},onSettled:()=>{}}),_e=()=>{I({isOpen:!1})},Se=()=>{f.current.hotInstance;const e=w.current.row;console.log("onDelete=",e),I({isOpen:!1}),je(e)},$e=async()=>{if(w.current&&f.current?.hotInstance){const e=m("delete_confirm_title"),s=m("delete_confirm_message_simple");I({isOpen:!0,title:e,message:s,color:"warning"})}else $({show:!0,message:m("select_row_to_delete")}),setTimeout(()=>{$({show:!1,message:""})},2e3)};if(n===void 0)return t.jsx("div",{className:"flex flex-col items-center justify-center h-full w-full mt-50",children:t.jsx(G,{children:m("login_required")})});const Z=()=>{const e=B.current.value;S(e);const s=f.current?.hotInstance;s&&s.render()},ke=e=>{e.key==="Enter"&&(e.preventDefault(),Z())};return ue||P===void 0||D===void 0||_===void 0?t.jsx(Ie,{}):t.jsxs("div",{className:"pt-5 relative",children:[t.jsx(Be,{...oe}),t.jsx(Re,{...z,onConfirm:Se,onClose:_e}),t.jsx("div",{className:"mb-4",children:se?t.jsxs("div",{className:`${M.card} p-4`,children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx(G,{children:m("input")}),t.jsx("textarea",{className:"w-full h-64 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500",value:Q,onChange:e=>W(e.target.value),autoFocus:!0})]}),t.jsxs("div",{children:[t.jsx(G,{children:m("preview")}),t.jsx("div",{className:"prose dark:prose-invert max-w-none p-2 border rounded h-64 overflow-y-auto dark:bg-gray-700 dark:border-gray-600",children:t.jsx(ee,{children:Q})})]})]}),t.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[t.jsx(H,{variant:"outlined",color:M.button.indigo,size:"sm",onClick:()=>K(!1),children:m("cancel")}),t.jsx(H,{color:M.button.indigo,onClick:we,children:m("save")})]})]}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"relative",children:t.jsxs("div",{className:`${M.card} p-4 min-h-[4rem] cursor-pointer prose dark:prose-invert max-w-none`,onDoubleClick:pe,children:[L?t.jsx(ee,{children:L}):t.jsx("p",{className:"text-gray-400",children:m("double_click_to_edit_memo")}),t.jsx("button",{onClick:()=>ae(!q),className:`${M.floatingActionButton} absolute bottom-4 right-2`,children:t.jsx(O.div,{animate:{rotate:q?45:0},children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})})})]})})})}),t.jsxs("div",{className:"flex items-center justify-between pb-2",children:[t.jsx(Ae,{inputRef:B,onKeyDown:ke,onSearch:Z}),t.jsx(U,{children:q&&t.jsx(O.div,{className:"absolute mb-5 buttom-0 right-0 z-180 flex flex-col items-end",initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},transition:{duration:.2,ease:"easeInOut"},children:t.jsx(Pe,{onInsert:fe,onDelete:$e,colorPalette:ne,textColorPalette:re,handleColorClick:le,handleColorRightClick:ie,handleTextColorClick:ce,handleTextColorRightClick:de,onCsvSave:me,onSaveAll:X,onCopy:n?.uid===Oe?De:null})},"fab-menu")})]}),t.jsx("div",{className:"relative",children:t.jsx(Ee,{hotRef:f,search:C,columns:b,rowData:P,colorData:D,colorTextData:_,afterSelection:be,handleAfterColumnResize:Ce})})]})};export{Je as MemoSheetGrid,Je as default};

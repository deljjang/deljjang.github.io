import{r as u,i as Q,bq as W,V as X,j as t,bu as T,bt as ee,c0 as te,a9 as C,a7 as ae,dF as se,dG as le,dH as L,dI as ne,K as U,p as oe,o as re,f as ie,t as ce,D as de,s as me,L as P}from"./index-DJthDwo5.js";import{T as ue}from"./TwTextArea-r3A3BnbF.js";import{T as ge,D as he,H as xe,u as fe}from"./useMemoMutation-BRfKIcsJ.js";import{u as ve,a as pe}from"./MemoComm-JuYBcYKX.js";import"./Delete-BNWlHEC_.js";import"./Divider-BCY0hNwg.js";import"./HomeChartSemiDonut-oBLdP6M1.js";import"./Favorite-VWK3PwPO.js";import"./angle-right-Cejw408k.js";const we=n=>{const[i,d]=u.useState(n.imageList),[s,x]=u.useState(n.content),{t:l}=Q(),[r,g]=u.useState(),h=u.useRef(),F=u.useRef(!1),y=u.useRef(null),c=u.useRef([]),{height:w}=W(),N={edTitle:n.title,edGbn:n.gbn?n.gbn:"etc",edDate:n.date,content:n.content,memoTxt:n.content,htmlCheck:"N",iconCheck:"N"},{register:k,handleSubmit:$,trigger:be,control:j,setValue:f,getValues:b,watch:ye,formState:{errors:Ce,isSubmitting:Ne}}=X({mode:"onChange",defaultValues:N});u.useEffect(()=>{k("edDate"),k("memoTxt")},[]),u.useEffect(()=>{c.current=[],h.current=n.content},[n.content]);const S=async e=>{await n.onPostSubmit(e,i,c.current)},I=()=>{$(S)()},R=e=>{d(e)},B=e=>{let a=h.current;e.ext==="jpg"||e.ext==="png"?(a+=`<img src='${e.url}'/>`,v(`<img src='${e.url}'/>
`)):e.ext==="mp4"?(a+=`<video preload="auto" controls="" src='${e.url}'></video>`,v(`<video preload="auto" controls="" src='${e.url}'></video>`)):(a+=`<a src='${e.url}'>${e.name}}</a>`,v(`${l("download_link_text")}
<a href="${e.url}" target="_blank">${e.name}</a>
`)),h.current=a},A=e=>n.onRename(e,b("edTitle")),Y=e=>{h.current=e},H=e=>{c.current=e};function M(e){v(`<img src='${e}'/>`)}function q(){let e="";i&&i.length>0&&i.map((a,o)=>{e+=`<img src="/data/memo/${a.key}.${a.ext}" style="width: 50px;"/>
`}),e!==""&&v(e)}const V=[{value:"none",label:l("none")},{value:"react",label:l("react")},{value:"css",label:l("css")},{value:"android",label:l("android")},{value:"java",label:l("java")},{value:"image",label:l("image")},{value:"etc",label:l("etc")},{value:"mui",label:l("mui")}],v=e=>{const a=y.current;if(a){const o=a.selectionStart,m=a.selectionEnd,p=s.slice(0,o),D=s.slice(m);x(p+e+D),f("memoTxt",p+e+D),setTimeout(()=>{a.selectionStart=a.selectionEnd=o+e.length,a.focus()},100)}},G=e=>{v(e)},O=e=>e?/\.(jpg|jpeg|png|gif|bmp|webp|svg)/i.test(e)||e.includes("image")||e.includes("img"):!1,z=async()=>{await se("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1")},J=async()=>{const e=await le("memo/I3cTgdCxwjhBBno4mtZYvnODPJu1");let a="";e.map(o=>{a+=o+`
`}),v(a)},Z=async()=>{const e=b("edFilePath");if(e===""){const a=[];let o=y.current.value;o=o.replace(/<img src="\/data\/memo\//g,""),o=o.replace(/ style="width: 50px;"/g,""),o=o.replace(/"\/>/g,""),o=o.replace(/ /g,""),o.split(`
`).forEach(async m=>{m.indexOf(".")>0&&a.push(m)}),a.length>0&&await n.onFilePathList(a)}else await n.onFilePath(e)},K=e=>new Promise((a,o)=>{const m=new Image;m.crossOrigin="anonymous",m.onload=()=>{const p=document.createElement("canvas"),D=p.getContext("2d");p.width=m.width,p.height=m.height,D.drawImage(m,0,0);try{const _=p.toDataURL("image/png");a(_)}catch(_){o(_)}},m.onerror=()=>{o(new Error("Failed to load image"))},m.src=e});return t.jsx("div",{className:"my-2 mb-[50px], w-full",children:t.jsxs("form",{onSubmit:$(S),style:{width:"100%",minHeight:"300px",maxHeight:{height:w},display:"flex",flexDirection:"column"},children:[t.jsx(ge,{onSubmit:e=>I(),onCancel:n.onCancel,isSubmitting:F.current}),t.jsx(he,{control:j,onDelete:R,onInsert:B,onRename:A,setContent:Y,onFileUpload:H,imageList:n.imageList}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{className:"w-full",children:t.jsx(T,{name:"edTitle",placeholder:l("title_placeholder"),control:j,className:"w-full",rules:{required:l("required_field"),minLength:{value:2,message:l("min_length_2")}},onChange:e=>{e.preventDefault(),f("edTitle",e.target.value)}})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(ee,{name:"edGbn",label:l("category"),control:j,rules:{required:!0},placeholder:l("category_placeholder"),options:V,className:"",allClassName:"max-w-40",onChange:e=>{e.preventDefault();const a=e.target.value;f("edGbn",a)}}),t.jsx(te,{id:"edDate",name:"edDate",placeholder:l("select_date_placeholder"),control:j,onChange:(e,a)=>{f("edDate",a)}})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(T,{name:"edUrl",placeholder:l("base64_url_placeholder"),control:j,className:"w-full",allClassName:"w-full",onChange:e=>{e.preventDefault();const a=e.target.value;f("edUrl",a),g(a)}}),t.jsx(C,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),M(b("edUrl2"))},children:l("apply")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(T,{name:"edUrl2",placeholder:l("base64_image_data_placeholder"),className:"w-full",allClassName:"w-full",variant:"filled",size:"md",value:b("edUrl2")||""}),t.jsx(C,{variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),q()},children:l("add_attachment")})]}),t.jsxs("div",{className:"flex gap-2 w-full",children:[t.jsx(T,{name:"edFilePath",placeholder:l("add_to_imagelist_placeholder"),className:"w-full",allClassName:"w-full",control:j,onChange:e=>{e.preventDefault();const a=e.target.value;f("edFilePath",a)}}),t.jsx(C,{size:"sm",variant:"outlined",color:"success",className:"w-25 h-9",onClick:e=>{e.preventDefault(),Z()},children:l("file_path")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(C,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),z()},children:l("all_files")}),t.jsx(C,{variant:"outlined",color:"success",onClick:e=>{e.preventDefault(),J()},children:l("all_files_10")})]})]}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"}),t.jsxs("div",{className:"grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2",children:[t.jsx("div",{children:t.jsx("div",{className:"max-h-100 overflow-y-scroll",children:t.jsx(ae,{postData:s})})}),t.jsx("div",{children:t.jsx(ue,{ref:y,className:"",value:s,onChange:e=>{f("memoTxt",e),x(e)},rows:20})}),b("edUrl")&&O(b("edUrl"))&&t.jsx("div",{className:"mt-2 p-2 border border-gray-300 dark:border-gray-600 rounded",children:t.jsx("img",{src:r,alt:l("preview"),className:"max-w-full h-auto max-h-48 object-contain",onLoad:async e=>{try{const a=await K(r);f("edUrl2",a)}catch(a){console.error("Base64 conversion failed:",a)}},onError:e=>{e.target.style.display="none"}})})]}),t.jsx(xe,{onClick:G}),t.jsx("div",{className:"w-full border-t border-gray-300 dark:border-gray-600 my-4"})]})})},je=async(n,i,d,s,x)=>{const l=n==="memo"?`${n}/${i.uid}/`:`${n}/`,r=await ne(l,s.key,x,s.ext);if(r.success){const g=n==="memo"?`memo_txt/${i.uid}/${d}/image/`:`home_txt/${d}/image/`;U(g+s.key,null);const h={...s,key:r.key,url:r.url,name:`${r.key}.${s.ext}`};return U(g+r.key,h),h}},E=async(n,i,d)=>{if(Array.isArray(d)&&d.length>0)for(const s of d)try{await L(n,i,s)}catch(x){console.error(`Error getting path for ${s}:`,x)}else typeof d=="string"&&await L(n,i,d)},Pe=n=>{const{rootDb:i,isLoading:d,memoDetailData:s}=n,{scrollYProgress:x}=ve();pe(x,{stiffness:100,damping:30,restDelta:.001});const l=oe(),{memoId:r}=re();ie();const{user:g}=ce();de();const h=()=>{const c=`/${i==="memo"?"m":i}/${r==="insert"?"":r}`;l(c)},F=fe(i,r),y=(c,w,N)=>{F.mutate({values:c,imageList:w,files:N})};return u.useEffect(()=>{s&&s.title!==void 0&&me({title:s.title,description:s.title});function c(){document.querySelectorAll("pre").forEach((w,N)=>{})}s&&s.memo!==null&&c()},[s]),r===""||g===void 0?t.jsx(t.Fragment,{}):s===void 0||d?t.jsx(P,{}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"w-full p-0 m-0",children:s&&(s.title===void 0||s.title===""||s.title===null)?t.jsx(P,{}):t.jsx(we,{onPostSubmit:y,onCancel:h,onRename:(c,w)=>je(i,g,r,c,w),onFilePath:c=>E(g.uid,r,c),onFilePathList:c=>E(g.uid,r,c),title:s?.title,gbn:s?.gbn,date:s?.date,htmlCheck:s?.html?s?.html==="Y"?"Y":"N":"Y",iconCheck:!s?.icon==="Y"?"Y":"N",content:s?.memo,imageList:s?.image})})})};export{Pe as TwMemoDetailUtil,Pe as default};

import{r as f,j as e,x as k,k as B,h as A,Q as U,eV as H,ck as Y,bh as q,K as P,a4 as T,o as W,z as X,s as J,u as G,q as Z,i as ee,ep as R,br as te,bs as se,A as Q,E as F,I as E,J as ae,bU as re,bq as ne}from"./index-CkNAgZXs.js";import{T as ie}from"./TwToast-Cc_iYg4I.js";import{C as oe}from"./ComponentCard-BLx4kEF4.js";const z=f.forwardRef(({size:u="md",color:d="default",name:b,placeholder:j,value:x,onChange:t,className:g="",allClassName:m="",min:h,max:n,step:p,disabled:a=!1,control:y,rules:_=null,defaultValue:l="",onKeyDownCapture:o,error:N,helperText:r,...v},L)=>{const M=y?._formState?.errors?.[b]?"error":d,I=w=>{t&&t(w)},s={sm:`h-9 px-3 py-2 ${k.textSm}`,md:`h-11 px-4 py-2.5 ${k.textSm}`,lg:"h-12 px-4 py-3 text-base"},i={default:"bg-transparent text-gray-800 border-gray-300 focus:border-brand-300 focus:ring-brand-500/20 dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800",success:"border-green-500 focus:border-green-300 focus:ring-green-500/20 dark:text-green-400 dark:border-green-500 dark:focus:border-green-800",error:"border-red-500 focus:border-red-300 focus:ring-red-500/20 dark:text-red-400 dark:border-red-500 dark:focus:border-red-800"},c="text-gray-500 border-gray-300 bg-gray-100 cursor-not-allowed opacity-60 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700",S=`w-full ${k.roundedLg} border appearance-none shadow-theme-xs placeholder:text-gray-400 focus:outline-none focus:ring-3 dark:bg-zinc-950 dark:placeholder:text-white/30`;return e.jsxs("div",{className:`relative ${m}`,children:[e.jsx("input",{type:"text",name:b,placeholder:j,ref:L,onChange:I,min:h,max:n,step:p,disabled:a,onKeyDownCapture:o,className:`
          ${S}
          ${s[u]}
          ${a?c:i[M]}
          ${g}
        `,...v}),r&&e.jsx("p",{className:`mt-1 ${k.textSm} text-red-600 dark:text-red-400`,children:r})]})});z.displayName="TwInputRef";const O=B.forwardRef(({title:u,children:d,className:b="",desc:j="",icon:x=null,isDraggable:t=!1},g)=>{const m=f.useRef(null),[h,n]=f.useState({x:0,y:0,isInitialized:!1}),[p,a]=f.useState(!1),y=f.useRef({x:0,y:0});f.useEffect(()=>{if(t&&m.current&&!h.isInitialized){const r=m.current.getBoundingClientRect(),v=window.innerWidth/2-672/2<=0?0:window.innerWidth/2-672/2;n({x:v,y:window.innerHeight/2-r.height/2,isInitialized:!0})}},[t,h.isInitialized]);const _=r=>{if(!t||!m.current)return;a(!0);const v=m.current.getBoundingClientRect();y.current={x:r.clientX-v.left,y:r.clientY-v.top},r.preventDefault()},l=r=>{if(!p)return;const v=r.clientX-y.current.x<=0?0:r.clientX-y.current.x,L=r.clientY-y.current.y<=120?120:r.clientY-y.current.y;n({...h,x:v,y:L})},o=()=>{a(!1)};f.useEffect(()=>(p?(window.addEventListener("mousemove",l),window.addEventListener("mouseup",o)):(window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",o)),()=>{window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",o)}),[p]);const N=t?{position:"absolute",top:h.y,left:h.x,cursor:p?"grabbing":"default"}:{};return e.jsxs("div",{ref:r=>{m.current=r,g&&(g.current=r)},className:`MoveCard ${k.card} ${b}`,style:{...N},children:[e.jsxs("div",{className:`flex px-6 py-5 items-center ${t?"cursor-grab":""}`,onMouseDown:_,children:[x!==null?x:"",e.jsxs("div",{className:"flex-grow",children:[e.jsx("h3",{className:`${k.textBase} ${k.fontMedium} text-gray-800 dark:text-white/90`,children:u}),j&&e.jsx("p",{className:`mt-1 ${k.textSm} text-gray-500 dark:text-gray-400`,children:j})]})]}),e.jsx("div",{className:`border-t border-gray-100 dark:border-gray-800 
        p-4 sm:p-6 overflow-x-auto`,children:e.jsx("div",{className:"space-y-6 whitespace-normal",children:d})})]})});O.displayName="MoveCard";const K=f.forwardRef(({name:u,options:d,rules:b,control:j,placeholder:x="Select Option",className:t="",allClassName:g="",...m},h)=>e.jsxs("div",{className:`relative ${g}`,children:[e.jsxs("select",{className:`h-11 w-full appearance-none ${k.roundedLg} border border-gray-300 
          bg-transparent px-4 py-2.5 pr-11 text-sm shadow-theme-xs placeholder:text-gray-400 
          focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 
          dark:border-gray-700 dark:bg-zinc-950 dark:text-white/90 dark:placeholder:text-white/30 
          dark:focus:border-brand-800 dark:bg-dark-900
          ${t}`,ref:h,...m,children:[e.jsx("option",{value:"",disabled:!0,className:"text-gray-700 dark:bg-zinc-950 dark:text-gray-400",children:x}),d.map(n=>e.jsx("option",{value:n.value,className:"text-gray-700 dark:bg-zinc-950 dark:text-gray-400",children:n.label},n.value))]}),e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 h-11",children:e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]}));K.displayName="TwSelectRef";const le=({isOpen:u,onClose:d,onCreate:b})=>{const j={visible:{opacity:1},hidden:{opacity:0}},x={hidden:{y:"-50px",opacity:0,scale:.95},visible:{y:"0",opacity:1,scale:1,transition:{duration:.2,ease:"easeOut"}},exit:{y:"50px",opacity:0,scale:.95,transition:{duration:.15,ease:"easeIn"}}},{t}=A(),{register:g,control:m,handleSubmit:h,formState:{errors:n}}=U({defaultValues:{title:"",columns:[{title:"col_0",type:"text",width:100,data:"col_0"},{title:"col_1",type:"text",width:100,data:"col_1"},{title:"col_2",type:"text",width:100,data:"col_2"}]}}),{fields:p,append:a,remove:y}=H({control:m,name:"columns"}),_=[{value:"text",label:t("column_type_text")},{value:"numeric",label:t("column_type_numeric")},{value:"date",label:t("column_type_date")},{value:"checkbox",label:t("column_type_checkbox")}],l=o=>{if(!o.title||o.title.trim()===""){alert(t("sheet_title_required"));return}const N={...o,columns:o.columns.map((r,v)=>r.data&&(r.data==="id"||r.data==="title"||r.data==="description")?r:{...r,data:(r.title||"").toLowerCase().replace(/\s+/g,"_")||`col_${v}`})};b(N)};return e.jsx(Y,{children:u&&e.jsx(q.div,{className:"fixed inset-0 bg-black/70 bg-opacity-50 z-180 flex justify-center items-center",variants:j,initial:"hidden",animate:"visible",exit:"hidden",children:e.jsx(q.div,{variants:x,initial:"hidden",animate:"visible",exit:"exit",onClick:o=>o.stopPropagation(),children:e.jsx(O,{isDraggable:!0,className:"w-full max-w-sm sm:max-w-xl max-h-[61vh] overflow-y-auto",title:t("create_new_sheet"),children:e.jsxs("form",{onSubmit:h(l),children:[e.jsx("div",{className:"mb-4",children:e.jsx(z,{...g("title",{required:t("sheet_title_required")}),label:t("sheet_title"),placeholder:t("sheet_title_placeholder"),error:!!n.title,helperText:n.title?.message})}),e.jsx("h3",{className:"text-md font-semibold mb-2",children:t("columns")}),e.jsx("div",{className:"space-y-3",children:p.map((o,N)=>e.jsxs("div",{className:`grid grid-cols-1 sm:grid-cols-5 gap-2 items-center p-2 ${k.border} rounded-md`,children:[e.jsx("div",{className:"sm:col-span-2",children:e.jsx(P,{name:`columns.${N}.title`,control:m,defaultValue:o.title,render:({field:r})=>e.jsx(z,{...r,placeholder:t("column_title")})})}),e.jsx("div",{className:"sm:col-span-2",children:e.jsx(P,{name:`columns.${N}.type`,control:m,defaultValue:o.type,render:({field:r})=>e.jsx(K,{...r,options:_,className:"dark:bg-gray-700"})})}),e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(T,{type:"button",size:"sm",color:"warning",onClick:()=>y(N),disabled:p.length<=1,children:t("delete")})})]},o.id))}),e.jsxs("div",{className:"flex justify-between items-center mt-6",children:[e.jsx(T,{type:"button",onClick:()=>a({title:"",type:"text",data:""}),children:t("add_column")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{type:"button",variant:"outlined",onClick:d,children:t("cancel")}),e.jsx(T,{type:"submit",children:t("create")})]})]})]})})})})})},de={isEditing:!1,editingTitle:""};function ce(u,d){switch(console.log("state",u),console.log("action",d),d.type){case"START_EDIT":return{isEditing:!0,editingTitle:d.payload.initialTitle};case"CANCEL_EDIT":return{isEditing:!1,editingTitle:""};case"UPDATE_TITLE":return{...u,editingTitle:d.payload};case"FINISH_EDIT":return{...u,isEditing:!1};default:throw new Error(`Unhandled action type: ${d.type}`)}}const ue=({sheet:u,onCardClick:d,onUpdateTitle:b,onShowToast:j,onDeleteClick:x})=>{const{t}=A(),[g,m]=f.useReducer(ce,de),{isEditing:h,editingTitle:n}=g,p=l=>{l.stopPropagation(),m({type:"START_EDIT",payload:{initialTitle:u.title}})},a=l=>{l.stopPropagation(),m({type:"CANCEL_EDIT"})},y=l=>{if(l.stopPropagation(),!n.trim()){j(t("sheet_title_required"),"red");return}b(u.id,n),m({type:"FINISH_EDIT"})},_=l=>{if(!l)return"";const o=new Date(l);return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")} ${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}`};return e.jsx("div",{onClick:()=>!h&&d(u.id),className:"relative flex flex-col justify-between p-4 bg-white dark:bg-zinc-900 rounded-lg shadow-lg hover:shadow-xl dark:hover:shadow-lg dark:hover:shadow-gray-800 hover:-translate-y-1 transition-all duration-300 cursor-pointer group",children:h?e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("input",{type:"text",value:n,onChange:l=>m({type:"UPDATE_TITLE",payload:l.target.value}),onClick:l=>l.stopPropagation(),className:"border p-2 rounded-md dark:bg-gray-700",autoFocus:!0}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(T,{size:"sm",variant:"outlined",onClick:a,children:t("cancel")}),e.jsx(T,{size:"sm",onClick:y,children:t("save")})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("h6",{className:"text-lg font-bold text-gray-800 dark:text-gray-100 truncate mb-2",children:u.title}),e.jsxs("div",{className:"absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:p,className:"p-1.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"})})}),e.jsx("button",{onClick:l=>{l.stopPropagation(),x(u.id)},className:"p-1.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4 text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[u.public==="Y"&&e.jsx("span",{className:"font-semibold px-2 py-0.5 rounded-full bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200",children:t("public")}),e.jsx("span",{children:_(u.createdAt)})]}),e.jsxs("span",{children:[t("count"),": ",u.count||0]})]})]})})};function pe({onDeleteTab:u}){const{t:d}=A(),b=W(),[j,x]=f.useState({isOpen:!1}),[t,g]=f.useState(!1),[m,h]=f.useState({show:!1,message:"",color:"red"}),n=X();f.useEffect(()=>{J({title:d("appSheet"),description:d("appSheet")})},[]);const{isExpanded:p}=G(),{user:a}=Z(),y=(s=!0)=>a?new Promise(i=>{const c=Q(F,`memo_sheet/${a.uid}`);ne(c,S=>{const w=S.val(),$=w?Object.keys(w).map(C=>({id:C,...w[C]})):[];$.sort((C,V)=>(V.createdAt||0)-(C.createdAt||0)),i($)},{onlyOnce:!0})}):Promise.resolve([]),{data:_,isLoading:l}=ee({queryKey:["sheets",a?.uid],queryFn:()=>y(),enabled:!!a}),o=R({mutationFn:async s=>{const i=`memo_sheet/${a.uid}`,c=te(se(Q(F),i)).key,S={title:s.title,columns:s.columns,createdAt:Date.now()};await E(`${i}/${c}`,S);const w=`memo_sheet_data/${a.uid}/${c}/data`,$={id:0,createdAt:Date.now()};return s.columns.forEach(C=>{C.data!=="id"&&C.data!=="createdAt"&&($[C.data]="")}),await E(`${w}/0`,$),$.id=1,await E(`${w}/1`,$),c},onSuccess:s=>{n.invalidateQueries({queryKey:["sheets",a?.uid]}),g(!1),b(`/m/sheet/${s}`)}}),N=R({mutationFn:s=>{const i=E(`memo_sheet/${a.uid}/${s}`,null),c=E(`memo_sheet_data/${a.uid}/${s}`,null);return Promise.all([i,c]).then(()=>s)},onMutate:async s=>{await n.cancelQueries({queryKey:["sheets",a?.uid]});const i=n.getQueryData(["sheets",a?.uid]);return n.setQueryData(["sheets",a?.uid],c=>c?.filter(S=>S.id!==s)),{previousSheets:i}},onError:(s,i,c)=>{n.setQueryData(["sheets",a?.uid],c.previousSheets)},onSettled:s=>{n.invalidateQueries({queryKey:["sheets",a?.uid]}),n.invalidateQueries({queryKey:["sheetData",s]})}}),r=R({mutationFn:({sheetId:s,title:i})=>E(`memo_sheet/${a.uid}/${s}/title`,i),onMutate:async({sheetId:s,title:i})=>{await n.cancelQueries({queryKey:["sheets",a?.uid]});const c=n.getQueryData(["sheets",a?.uid]);return n.setQueryData(["sheets",a?.uid],S=>S?.map(w=>w.id===s?{...w,title:i}:w)),{previousSheets:c}},onError:(s,i,c)=>{n.setQueryData(["sheets",a?.uid],c.previousSheets)},onSettled:()=>{n.invalidateQueries({queryKey:["sheets",a?.uid]})}}),v=s=>{b(`/m/sheet/${s}`)},L=async(s,i)=>{x({isOpen:!0,title:d("delete_confirm_title"),message:d("delete_confirm_message"),color:"warning",onConfirm:()=>{N.mutate(s),x({isOpen:!1})},onClose:()=>x({isOpen:!1})})},D=p?"grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3":"grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5",M=()=>e.jsx("div",{className:`grid ${D} gap-4`,children:Array.from({length:p?6:8}).map((s,i)=>e.jsxs("div",{className:"flex flex-col justify-between p-4 bg-white dark:bg-zinc-900 rounded-lg shadow-md",children:[e.jsx("div",{className:"flex-grow animate-pulse",children:e.jsx("div",{className:"h-6 bg-gray-200 dark:bg-zinc-800 rounded w-3/4 mb-2"})}),e.jsxs("div",{className:"flex justify-between items-center mt-4 animate-pulse",children:[e.jsx("div",{className:"flex items-center gap-2 w-full",children:e.jsx("div",{className:"h-4 bg-gray-200 dark:bg-zinc-800 rounded w-1/2"})}),e.jsx("div",{className:"h-4 bg-gray-200 dark:bg-zinc-800 rounded w-1/4"})]})]},i))});if(l||a===void 0)return e.jsx(M,{});const I=e.jsxs("div",{className:`${k.between}`,children:[e.jsx(ae,{className:"text-md",children:d("memo_sheet_list")}),e.jsx(T,{variant:"ghost",color:"sky",onClick:()=>g(!0),children:d("create_new_sheet")})]});return e.jsxs(e.Fragment,{children:[e.jsx(ie,{...m}),e.jsxs(oe,{title:I,className:"my-5",children:[e.jsx(re,{...j}),e.jsx(le,{isOpen:t,onClose:()=>g(!1),onCreate:s=>o.mutate(s)}),e.jsx("div",{className:`grid ${D} gap-4`,children:_?.map(s=>e.jsx(ue,{sheet:s,onCardClick:v,onUpdateTitle:(i,c)=>r.mutate({sheetId:i,title:c}),onShowToast:(i,c)=>{h({show:!0,message:i,color:c}),setTimeout(()=>h({show:!1,message:""}),3e3)},onDeleteClick:i=>L(i)},s.id))})]})]})}export{pe as default};

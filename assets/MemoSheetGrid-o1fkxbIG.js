import{h as Z,j as t,a4 as _,q as ke,a2 as H,n as Fe,z as Te,r as u,Q as Me,i as Ie,cc as S,ep as Q,I as y,J,ck as Ae,bh as Re,bU as ze,x as A,eW as Oe}from"./index-CnC8s_ff.js";import{a as Ee}from"./MemoDetailGrid-DAzSVe5j.js";import{A as R}from"./AniButton-hkXMdXg6.js";import{M as X}from"./HtmlCode-Vm9Lpl8N.js";import"./Button-C6oIcZuj.js";import"./copy-DRCzP2OU.js";import"./ComponentCard-CLyclhOc.js";import"./TwRadio-VkOiaiv7.js";import"./TwBadge-BlbdB75p.js";import"./HtmlCode-CvDgGx9n.js";import"./toPropertyKey-DCwh5dYN.js";const Pe=({ui:T,onInsert:a,onDelete:M,onReload:m,onCsvSave:n,onSaveAll:v,onCopy:C})=>{const{t:p}=Z();return T==="tailwind"?t.jsxs("div",{className:"my-2 flex justify-end items-center",children:[t.jsx(_,{size:"sm",variant:"outlined",color:"brand",className:"mr-2",onClick:C,children:p("copy")}),t.jsx(_,{size:"sm",variant:"outlined",color:"brand",className:"mr-2",onClick:v,children:p("save")}),t.jsx(_,{size:"sm",variant:"outlined",color:"brand",className:"mr-2",onClick:a,children:p("insert")}),t.jsx(_,{size:"sm",variant:"outlined",color:"warning",className:"mr-1",onClick:M,children:p("delete")}),t.jsx(_,{size:"sm",variant:"outlined",color:"brand",className:"ml-1",onClick:n,children:p("csv_save")})]}):t.jsxs("div",{className:"my-2 flex justify-end items-center gap-1",children:[t.jsx(R,{type:"button",size:"small",variant:"outlined",color:"warning",className:"mr-2",onClick:a,children:p("insert")}),t.jsx(R,{type:"button",size:"small",variant:"outlined",color:"error",className:"mr-2",onClick:M,children:p("delete")}),t.jsx(R,{type:"button",size:"small",variant:"outlined",color:"success",className:"mr-2",onClick:m,children:p("reload")}),t.jsx(R,{type:"button",size:"small",variant:"outlined",color:"success",onClick:n,children:p("csv_save")})]})},ot=({detailData:T})=>{const{user:a}=ke(),{ui:M}=H(),{t:m}=Z(),{sheetId:n}=Fe(),v=Te(),[C,p]=u.useState([]),f=u.useRef(null),q=u.useRef(null),x=u.useRef(null),[K,ee]=u.useState([]),[N,z]=u.useState(void 0),[$,O]=u.useState(void 0),[te,se]=u.useState(""),[oe,E]=u.useState({isOpen:!1}),[L,j]=u.useState({show:!1,message:""}),[P,U]=u.useState(""),[ae,B]=u.useState(!1),[I,V]=u.useState(""),ne=["#FFADAD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF"],re=["#000000","#D00000","#AE4600","#006400","#00529B","#0018A8","#5A00A8","#A800A8"],ie=e=>{if(!f.current?.hotInstance||!x.current)return;const{row:o,col:r,row2:i,col2:d}=x.current,l=Math.min(o,i),c=Math.max(o,i),b=Math.min(r,d),w=Math.max(r,d),h=[...N];let F=!1;for(let g=l;g<=c;g++){h[g]||(h[g]=Array(C.length).fill(""));for(let D=b;D<=w;D++)h[g][D]!==e&&(h[g][D]=e,F=!0)}F&&z(h)},le=(e,s)=>{e.preventDefault();const o=f.current?.hotInstance;if(!o)return;const r=o.countRows(),i=[...N];let d=!1;for(let l=0;l<r;l++)if(i[l])for(let c=0;c<i[l].length;c++)i[l][c]===s&&(i[l][c]=void 0,d=!0);d&&z(i)},ce=e=>{if(!f.current?.hotInstance||!x.current)return;const{row:o,col:r,row2:i,col2:d}=x.current,l=Math.min(o,i),c=Math.max(o,i),b=Math.min(r,d),w=Math.max(r,d),h=[...$];let F=!1;for(let g=l;g<=c;g++){h[g]||(h[g]=Array(C.length).fill(void 0));for(let D=b;D<=w;D++)h[g][D]!==e&&(h[g][D]=e,F=!0)}F&&O(h)},de=(e,s)=>{e.preventDefault();const o=f.current?.hotInstance;if(!o)return;const r=o.countRows(),i=[...$];let d=!1;for(let l=0;l<r;l++)if(i[l])for(let c=0;c<i[l].length;c++)i[l][c]===s&&(i[l][c]=void 0,d=!0);d&&O(i)},{theme:Be}=H(),{register:ue,reset:Qe,control:Je,setValue:qe,getValues:Ke,formState:{errors:Le}}=Me({mode:"submit "}),{data:k,isLoading:me}=Ie({queryKey:["sheetData",n,a?.uid],queryFn:async()=>{if(!n||!a)return{rowData:[],colorData:[],colorTextData:[]};const e=`memo_sheet_data/${a?.uid}/${n}/data`,s=`memo_sheet_data/${a?.uid}/${n}/color`,o=`memo_sheet_data/${a?.uid}/${n}/textColor`,[r,i,d]=await Promise.all([S(e),S(s),S(o)]),l=r?Object.values(r).map(w=>typeof w=="string"?JSON.parse(w):w):[],c=i?Object.values(i).map(w=>JSON.parse(w)):[],b=d?Object.values(d).map(w=>JSON.parse(w)):[];return{rowData:l,colorData:c,colorTextData:b}},enabled:!!n&&!!a&&C.length>0,staleTime:1e3*60*5});u.useEffect(()=>{k&&(ee(k.rowData),z(k.colorData),O(k.colorTextData))},[k]);function he(){const e=T?.scrollY?T.scrollY:0;window.scrollTo({top:e})}u.useEffect(()=>{n&&a&&(S(`memo_sheet/${a?.uid}/${n}/columns`).then(e=>{p(e||[{title:"title",data:"title",type:"text"}]),ue("filterField1")}),S(`memo_sheet_data/${a?.uid}/${n}/memo`).then(e=>{U(e||"")}),he())},[n,a]);const fe=async()=>{f.current.hotInstance.getPlugin("exportFile").downloadFile("csv",{filename:`sheet_${n}`,mimeType:"text/csv",bom:!1,columnDelimiter:",",rowDelimiter:`\r
`})};async function ge(){const e=f.current?.hotInstance;if(!e)return;let s;x.current&&x.current.row>=0?(s=x.current.row+1,e.alter("insert_row_below",x.current.row,1)):(s=0,e.alter("insert_row_above",0,1)),e.selectCell(s,0)}const{mutate:pe}=Q({mutationFn:async({rowsDB:e,bgColorDataToSave:s,textColorDataToSave:o})=>{await ve(e,s,o)},onMutate:async({rowsDB:e,bgColorDataToSave:s,textColorDataToSave:o})=>{await v.cancelQueries({queryKey:["sheetData",n,a?.uid]});const r=v.getQueryData(["sheetData",n,a?.uid]),i=e.map(c=>JSON.parse(c)),d=s.map(c=>JSON.parse(c)),l=o.map(c=>JSON.parse(c));return v.setQueryData(["sheetData",n,a?.uid],c=>({...c,rowData:i,colorData:d,colorTextData:l})),{previousSheetData:r}},onError:(e,s,o)=>{o?.previousSheetData&&v.setQueryData(["sheetData",n,a?.uid],o.previousSheetData)},onSuccess:()=>{j({show:!0,message:m("save_completed")}),setTimeout(()=>j({show:!1,message:""}),2e3)},onSettled:()=>{v.invalidateQueries({queryKey:["sheetData",n,a?.uid]})}}),xe=async()=>{y(`memo_sheet_data/${a?.uid}/${n}/memo`,I),U(I),B(!1)},we=()=>{V(P),B(!0)},ve=(e,s,o)=>{y(`memo_sheet_data/${a?.uid}/${n}/data`,null),e.map((r,i)=>{y(`memo_sheet_data/${a?.uid}/${n}/data/${i}`,r)}),y(`memo_sheet_data/${a?.uid}/${n}/color`,s),y(`memo_sheet_data/${a?.uid}/${n}/textColor`,o),y(`memo_sheet/${a?.uid}/${n}/createdAt`,Date.now()),y(`memo_sheet/${a?.uid}/${n}/count`,e.length)},De=Q({mutationFn:async()=>{if(!a||!n)throw new Error("User or Sheet ID is missing.");const e=`memo_sheet/${a.uid}/${n}`,s=`memo_sheet_data/${a.uid}/${n}`,[o,r]=await Promise.all([S(e),S(s)]);if(console.log("sheetMeta=",o),console.log("sheetData=",r),!o)throw new Error("Sheet metadata not found.");const i={createdAt:o.createdAt||Date.now(),title:`${o.title}`,uid:a.uid,columns:o.columns||[],memo:r?.memo||"",color:r?.color||[],textColor:r?.textColor||[],data:r?.data||[],html:"sheet"};await y(`home_txt/${n}`,i)},onSuccess:()=>{j({show:!0,message:m("copy_completed")}),setTimeout(()=>j({show:!1,message:""}),2e3)},onError:e=>{console.error("Copy failed:",e);const s=`${m("copy_failed")} ${e.message?`: ${e.message}`:""}`;j({show:!0,message:s}),setTimeout(()=>j({show:!1,message:""}),3e3)}}),ye=()=>{De.mutate()},G=async(e=!0)=>{const s=f.current?.hotInstance;if(!s)return;const o=s.getSourceData(),r=[];o.forEach((l,c)=>{l.id=c;const b=[];C.forEach((w,h)=>{b.push(l[h]?l[h]:"")}),r.push(JSON.stringify(b))}),console.log("rowsDB=",r);const i=N.map(l=>JSON.stringify(l||[])),d=$.map(l=>JSON.stringify(l||[]));console.log("rowData=",r),console.log("bgColorDataToSave=",i),console.log("textColorDataToSave=",d),pe({rowsDB:r,bgColorDataToSave:i,textColorDataToSave:d})},Ce=(e,s,o,r)=>{x.current={row:e,col:s,row2:o,col2:r}},je=async(e,s,o)=>{G(!1);const r=f.current?.hotInstance;if(!r)return;const i=C.map((d,l)=>({...d,width:r.getColWidth(l)}));p(i),y(`memo_sheet/${a?.uid}/${n}/columns`,i)},{mutate:be}=Q({mutationFn:async e=>e,onMutate:async e=>{await v.cancelQueries({queryKey:["sheetData",n,a?.uid]});const s=v.getQueryData(["sheetData",n,a?.uid]);return v.setQueryData(["sheetData",n,a?.uid],o=>{const r=[...o.rowData];return r.splice(e,1),{...o,rowData:r}}),f.current?.hotInstance.alter("remove_row",e,1),x.current=null,{previousSheetData:s}},onError:(e,s,o)=>{v.setQueryData(["sheetData",n,a?.uid],o.previousSheetData)},onSettled:()=>{}}),Se=()=>{E({isOpen:!1})},_e=()=>{f.current.hotInstance;const e=x.current.row;console.log("onDelete=",e),E({isOpen:!1}),be(e)},Ne=async()=>{if(x.current&&f.current?.hotInstance){const e=m("delete_confirm_title"),s=m("delete_confirm_message_simple");E({isOpen:!0,title:e,message:s,color:"warning"})}else j({show:!0,message:m("select_row_to_delete")}),setTimeout(()=>{j({show:!1,message:""})},2e3)};if(a===void 0)return t.jsx("div",{className:"flex flex-col items-center justify-center h-full w-full mt-50",children:t.jsx(J,{children:m("login_required")})});const W=()=>{const e=q.current.value;se(e);const s=f.current?.hotInstance;s&&s.render()},$e=e=>{e.key==="Enter"&&(e.preventDefault(),W())},Y=()=>t.jsxs("div",{className:"pt-5",children:[t.jsx("div",{className:"mb-4 h-14 bg-gray-200 dark:bg-zinc-800 rounded-md animate-shimmer relative overflow-hidden"}),t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 pb-2 items-end",children:t.jsx("div",{className:"h-10 bg-gray-200 dark:bg-zinc-900 rounded-md animate-shimmer relative overflow-hidden"})}),t.jsxs("div",{className:"mt-2 space-y-1",children:[t.jsx("div",{className:"h-10 bg-gray-200 dark:bg-zinc-900 rounded-t-md animate-shimmer relative overflow-hidden"}),[...Array(5)].map((e,s)=>t.jsx("div",{className:"h-8 bg-gray-300 dark:bg-zinc-800 rounded animate-shimmer relative overflow-hidden"},s))]})]});return me?t.jsx(Y,{}):K===void 0||N===void 0||$===void 0?t.jsx(Y,{}):t.jsxs("div",{className:"pt-5 relative",children:[t.jsx(Ae,{children:L.show&&t.jsx(Re.div,{initial:{y:"-100%",opacity:0},animate:{y:0,opacity:1},exit:{y:"-100%",opacity:0},transition:{duration:.3,ease:"easeInOut"},className:"fixed top-50 left-1/2 -translate-x-1/2 z-[2000] p-3 rounded-lg shadow-lg bg-green-500 text-white font-semibold",children:L.message})}),t.jsx(ze,{...oe,onConfirm:_e,onClose:Se}),t.jsx("div",{className:"mb-4",children:ae?t.jsxs("div",{className:`${A.card} p-4`,children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx(J,{children:m("input")}),t.jsx("textarea",{className:"w-full h-64 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500",value:I,onChange:e=>V(e.target.value),autoFocus:!0})]}),t.jsxs("div",{children:[t.jsx(J,{children:m("preview")}),t.jsx("div",{className:"prose dark:prose-invert max-w-none p-2 border rounded h-64 overflow-y-auto dark:bg-gray-700 dark:border-gray-600",children:t.jsx(X,{children:I})})]})]}),t.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[t.jsx(_,{variant:"outlined",color:A.button.indigo,size:"sm",onClick:()=>B(!1),children:m("cancel")}),t.jsx(_,{color:A.button.indigo,onClick:xe,children:m("save")})]})]}):t.jsx("div",{className:`${A.card} p-4 min-h-[4rem] cursor-pointer prose dark:prose-invert max-w-none`,onDoubleClick:we,children:P?t.jsx(X,{children:P}):t.jsx("p",{className:"text-gray-400",children:m("double_click_to_edit_memo")})})}),t.jsxs("div",{className:"group",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 pb-2 items-end",children:[t.jsx("div",{className:"TwInputSearch",children:t.jsx(Oe,{inputRef:q,onKeyDown:$e,onSearch:W})}),t.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-300",children:t.jsxs("div",{className:"flex flex-col items-end",children:[t.jsx(Pe,{ui:M,onInsert:ge,onDelete:Ne,onCsvSave:fe,onSaveAll:G,onCopy:ye}),t.jsxs("div",{className:"flex items-center justify-end mt-1",children:[ne.map(e=>t.jsx("div",{onClick:()=>ie(e),onContextMenu:s=>le(s,e),className:"w-5 h-5 cursor-pointer border border-gray-400",style:{backgroundColor:e}},`bg-${e}`)),re.map((e,s)=>t.jsx("div",{onClick:()=>ce(e),onContextMenu:o=>de(o,e),className:"w-5 h-5 cursor-pointer border border-gray-400 flex items-center justify-center text-xs font-bold",style:{backgroundColor:"#fff",color:e},children:s%2===0?"ê°€":"A"},`text-${e}`))]})]})})]}),t.jsx(Ee,{hotRef:f,search:te,columns:C,rowData:K,colorData:N,colorTextData:$,afterSelection:Ce,handleAfterColumnResize:je})]})]})};export{ot as MemoSheetGrid,ot as default};
